# 回测策略管理模块需求草稿

## 背景
- 交易数据管理模块已提供标准化行情与特征数据，满足回测基础数据需求。
- 量化研究团队需要集中管理策略脚本与参数，并快速发起多场景回测。
- 现有回测流程分散在本地脚本与零散文档中，缺乏版本管理与结果归档。

## 目标与范围
- 提供策略脚本、元数据、参数模板的统一管理能力，确保版本可追溯。
- 建立回测任务配置向导，让用户在可视化界面中完成策略回测配置与启动。
- 输出标准化的回测结果与指标分析，支持多维筛选、对比与导出。
- 当前阶段聚焦功能闭环，不对资源配额、监控告警等平台能力做深入实现。
- 相关技术方案详见《[回测系统架构设计](../../architecture/backtesting-system-architecture.md)》与《[回测脚本架构设计](../../architecture/backtesting-script-architecture.md)》。

## 功能需求

### 1. 回测策略管理
- **策略基础信息维护**  
  维护策略名称、策略说明、标签等元数据；提供列表、详情页、检索与筛选；自动记录创建人与更新时间。
- **脚本上传与版本库**  
  支持上传/更新策略代码；自动生成版本号（如 v1.0.0）并记录版本描述；允许标记主版本；创建策略时可选择是否上传首个脚本版本。
- **策略生命周期管理**  
  提供创建、编辑、复制、归档/取消归档操作；自动记录操作日志；支持导出策略配置快照。

### 2. 回测执行
- **回测任务配置向导**  
  选择策略及脚本版本；配置数据源（选择数据集、时间区间、交易时间级别、交易时段）；配置资金与成本参数（初始资金、手续费率、滑点模型、杠杆倍数）；配置风险约束（可选）；自动渲染策略自定义参数字段，并支持输入校验与保存预设配置。
- **交易时段配置**  
  支持预设时段模板（RTH常规时段/ETH延时时段/全时段/自定义）；允许设置多个不连续的交易时段组合；持仓可跨时段保持，引擎仅在指定时段内执行策略逻辑；非交易时段的行情数据不触发策略的onBar回调。
- **风险约束执行机制**  
  风险约束由回测引擎在平台层面强制执行，策略脚本无需感知；当触发最大回撤限制时，引擎强制平仓并终止回测；当触发单日最大亏损限制时，引擎强制平仓并暂停当日交易；所有风控触发事件记录在交易明细与日志中，便于事后分析。
- **因子采集与记录**  
  策略脚本可在开仓/平仓时记录自定义因子（如RSI、波动率、入场原因等）；系统自动采集默认因子（交易时间、持仓时长、盈亏比例、账户净值等）；因子数据与每笔交易关联存储，用于后续多维分析。
- **任务调度与状态管理**  
  每次执行生成独立任务 ID，记录状态流转（待执行/队列中/执行中/成功/失败/终止）；展示运行时长、触发人；支持手动终止、失败重试、复制配置后再次发起。
- **执行过程反馈**  
  实时展示进度百分比、里程碑阶段与关键日志片段；保留完整日志文件供下载回溯。
- **输出产物管理**  
  将回测输出（绩效指标 JSON、交易明细、因子数据、图表数据、回测快照文件等）与任务记录关联；支持设置保留周期与下载权限。

### 3. 回测结果分析
- **基础绩效指标库**  
  标准化输出收益率、年化收益、最大回撤、夏普比率、卡玛比率、胜率、收益波动等指标；可配置基准组合用于对比；生成完整回测结果作为基准报告。
- **因子分析视图**  
  基于回测任务的完整交易数据，支持创建多个因子分析视图；每个视图通过因子筛选条件（如特定RSI区间、特定交易时段、特定市场状态等）过滤交易数据，生成独立的分析报告；支持保存常用筛选条件模板。
- **视图创建向导**  
  采用向导式交互创建因子分析视图：选择要筛选的因子 → 设置筛选条件（数值范围、分类匹配、组合逻辑）→ 预览筛选结果（交易笔数、时间分布）→ 生成分析报告；支持同时创建多个视图用于对比分析。
- **多维筛选与对比**  
  按自定义因子、系统默认因子、时间窗口、市场情境等维度筛选回测数据；支持选择2-4个因子分析视图进行对比，并排展示各视图的关键指标、净值曲线、交易分布、胜率收益等差异；辅助识别策略在不同市场环境下的表现特征。
- **事件复盘与上下文还原**  
  展示账户净值曲线、订单/成交明细、资金占用、风险提示日志等视图；支持跳转到特定时间段查看上下文；交易明细中标注因子信息，便于分析特定因子组合下的交易行为。
- **对比与导出**  
  支持多任务/多版本对比视图，展示指标、净值曲线与收益分布；支持多个因子分析视图的对比与导出；允许导出报表（PDF/Excel）与原始数据集，方便外部分析或汇报。


> 本文为阶段性草稿，后续将根据产品评审与技术评估持续迭代。



