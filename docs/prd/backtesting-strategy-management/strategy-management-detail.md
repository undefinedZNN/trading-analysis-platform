# 策略管理功能需求

## 1. 背景
交易回测模块需要提供完整的策略管理能力，策略使用者可以集中维护策略元信息、管理 TypeScript 脚本版本，并为回测任务提供可选的脚本版本与相关 Schema。主 PRD 已定义策略管理在整体流程中的位置，本文件进一步细化页面级需求、操作流程与交互约束。

## 2. 目标
- 让策略使用者可以创建、搜索、查看、编辑回测策略。
- 提供脚本版本管理能力：自动生成版本记录、允许命名、复制、对比与设置 `master`。
- 确保脚本声明的自定义参数/因子 Schema 在保存策略时保持完整性，供回测任务与分析复用。
- 提供基础的审计信息（创建人、更新时间、版本历史）以便追溯。

## 3. 范围
- 策略列表页、策略详情页、脚本编辑器。
- 版本管理相关操作（新建、复制、对比、设为 `master`、删除草稿）。
- Schema 管理（参数/因子字段定义，校验规则）。
- 不包含策略执行/回测结果查看；不包含权限与团队协作细则。

## 4. 用户故事
- 作为策略使用者，我可以新建一个策略，录入基础信息并保存脚本，系统自动生成第一个脚本版本。
- 作为策略使用者，我可以在策略列表中快速找到某个策略并查看其最近的脚本版本与 `master` 标记。
- 作为策略使用者，我可以在脚本编辑器中修改代码、更新 Schema，保存后自动生成新的脚本版本，并调整版本号。
- 作为策略使用者，我可以复制历史脚本版本，在此基础上继续编辑，不影响原版本。
- 作为策略使用者，我可以对比两个脚本版本的差异，确认代码与 Schema 的变更。
- 作为策略使用者，我可以将某个脚本版本标记为 `master`，便于回测任务默认使用。

## 5. 功能需求

### 5.1 策略列表
- 列表信息：策略名称、策略描述、标签（最多 6 个）、创建人、创建时间、最近更新时间、最近保存的脚本版本号、`master` 脚本版本号、最近回测任务状态摘要。
- 筛选/搜索：支持按策略名称关键字、标签（多选且去重）、创建人、更新时间范围筛选。
- 排序：默认按最近更新时间倒序，可切换按创建时间。
- 操作：
  - 新建策略：跳转到策略创建流程。
  - 查看详情：打开策略详情页（默认展示脚本版本列表）。

### 5.2 策略创建
- 基础信息表单：
  - `name`（必填，唯一，长度 3-50 字符）。
  - `description`（选填，≤ 200 字符）。
  - `tags`（选填，可多选/多填标签，单个策略最多 6 个；支持创建新标签并做重复校验）。
- 保存后自动进入脚本编辑器流程，生成第一个脚本版本。
- 若创建过程中取消，需提示未保存内容并确认退出。

### 5.3 脚本版本管理
- 版本列表展示字段：版本号、是否 `master`、创建人、创建时间、备注（可选）、最近一次应用时间（如被回测任务引用时更新）。
- 自动版本号规则：
  - 保存脚本时默认生成 `v{YYYYMMDD}.{序号}`，同一天从 `.1` 递增。
  - 用户可在保存成功后编辑版本号，需符合正则 `^v\d+(\.\d+)*$`（仅允许小写 `v` 开头），长度 ≤ 20 字符。
  - 保存时需校验版本号唯一且不与历史版本重复。
- `master` 标记：
  - 列表操作项 “设为 master”，需弹出确认提醒当前 `master` 将被替换。
  - 同一策略始终只有一个 `master`，取消 `master` 需要指定新的 `master`（不提供无 `master` 状态）。
- 复制版本：
  - 操作会生成一个新的版本草稿，继承原版本的源码、Schema、备注。
  - 草稿在保存前可编辑版本号，保存后按自动规则生成实际版本记录。
- 删除草稿：
  - 仅对未保存的临时草稿生效；已保存版本不可删除（保留历史追溯）。

### 5.4 脚本编辑器
- 编辑区域：
  - TypeScript 代码编辑器（支持语法高亮、基本提示、格式化）。
  - 代码保存前进行静态检查（在后端执行 TS 类型检查 + ESLint 基础规则）；失败时阻止保存并返回结构化错误信息（含行号、错误描述）。
- 自定义参数 Schema 编辑：
  - 使用轻量 Schema Renderer 表格形式维护字段列表，至少包含字段 `key`、`label`、`type`、`component`、`defaultValue`、`required`、`validator`、`enumOptions`（当类型为枚举时）。
  - 新增/删除字段需校验 `key` 唯一，`component` 必须与 `type` 合法组合。
  - 校验规则：`validator` 支持选择内置校验（数值范围、字符串长度、必填等）或输入 JS 表达式字符串；保存时仅校验格式/语法，不执行表达式，实际执行由策略 SDK 在运行时承担。
- 自定义因子 Schema 编辑：
  - 与参数 Schema 共用同一套渲染器，字段含义一致。
  - 支持标记字段类别（系统、脚本）仅用于展示；系统因子列表由平台维护，脚本因子由策略定义。
- 保存流程：
  - 点击“保存版本”→ 触发代码校验 + Schema 校验 → 成功后生成新版本记录。
  - 弹出保存结果，展示版本号，可立即编辑备注、版本号。
  - 保存成功后返回版本列表并突出显示刚创建的版本。

### 5.5 版本对比
- 支持在版本列表选中两个版本进行对比。
- 对比内容：
  - 代码 diff（展开为左右对比或高亮行差）。
  - 参数 Schema diff：新增/删除/修改字段高亮展示（按 key 比对）。
  - 因子 Schema diff：同上。
- 导出对比结果暂不纳入 MVP，后续视需求评估。

### 5.6 审计与关联信息
- 版本记录需展示创建人、创建时间、最后编辑人（脚本保存人）、最近引用的回测任务 ID 列表（显示最近 5 条）。
- 策略详情页显示策略创建人、更新时间、所属团队（暂用默认值，后续扩展）。

## 6. 状态与权限
- 当前阶段假设统一用户角色，所有策略使用者可创建/编辑/查看策略。
- 后续如需权限控制需在此基础上扩展（记录在主 PRD 的“后续规划”）。

## 7. 交互设计要点
- 策略列表与详情采用左右分栏结构：左侧为策略筛选列表，右侧为详情/编辑区域。
- 脚本编辑器内提示未保存改动（离开页面需提示）。
- 版本号编辑支持 inline 编辑 + 校验，错误提示贴近输入框。
- Schema 编辑器提供字段排序（拖拽或上移/下移按钮），以调整参数显示顺序。
- 版本对比弹窗/页面需支持切换不同对比视图（代码 vs Schema）。

## 8. 数据结构与字段约定（草案）
- `Strategy`：
  - `id`、`name`、`description`、`tags`、`createdAt`、`updatedAt`、`defaultScriptVersionId`（master）。
- `ScriptVersion`：
  - `id`、`strategyId`、`versionName`、`code`、`parameterSchema`、`factorSchema`、`isMaster`（衍生）、`createdBy`、`createdAt`、`lastReferencedAt`、`remark`。
- `parameterSchema` / `factorSchema` 字段与轻量 Schema Renderer 定义一致，保持 Formily 兼容命名。

## 9. 验收要点
- 新建策略后自动存在一个有效的脚本版本，并可被回测任务引用。
- 版本保存时若校验失败（代码或 Schema）将阻止生成版本，给出明确提示。
- 设置 `master` 后，在回测任务创建页默认选中该版本。
- 版本列表准确展示历史版本，且版本号编辑遵循规范。

## 10. 风险与后续事项
- Schema 兼容性：需与回测任务、结果分析两个模块对齐字段含义，避免后期重复改动。
- 代码校验性能：TypeScript 检查会影响保存耗时，需要评估是否在前端/后端执行。
- 版本历史量：长期可能积累大量版本，需要后续设计归档/分页方案。
