# 回测策略管理模块 UI 交互设计

## 页面结构总览

```
回测策略管理
├── 策略列表页
├── 策略详情页
│   ├── 基本信息 Tab
│   ├── 脚本版本 Tab
│   └── 回测历史 Tab
├── 创建/编辑策略弹窗
├── 创建/编辑脚本版本弹窗
├── 回测任务列表页
├── 回测任务详情页
└── 创建回测任务向导
```

---

## 1. 策略列表页

### 页面布局
```
┌─────────────────────────────────────────────────────────────────┐
│ 回测策略管理                                    [+ 创建策略]      │
├─────────────────────────────────────────────────────────────────┤
│ 🔍 搜索策略名称...     [标签筛选 ▼]  [状态 ▼]  [排序 ▼]         │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 📊 趋势跟踪策略 v2.1.0                    [运行中] [⭐主版本] │   │
│ │ 标签: #趋势 #期货                                           │   │
│ │ 说明: 基于均线交叉的趋势跟踪策略...                         │   │
│ │ 创建: 张三 · 2025-10-15  更新: 2025-10-20                  │   │
│ │                                    [编辑] [回测] [查看详情] │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                   │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 📈 均值回归策略 v1.5.2                        [草稿]        │   │
│ │ 标签: #均值回归 #股票                                       │   │
│ │ 说明: 基于布林带的均值回归策略...                           │   │
│ │ 创建: 李四 · 2025-10-18  更新: 2025-10-22                  │   │
│ │                                    [编辑] [回测] [查看详情] │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                   │
│                          [1] 2 3 4 ... 10                        │
└─────────────────────────────────────────────────────────────────┘
```

### 交互说明
- **搜索框**: 实时搜索策略名称和说明
- **标签筛选**: 多选下拉，显示所有已使用的标签
- **状态筛选**: 草稿/运行中/已归档
- **排序**: 最近更新/最近创建/名称A-Z
- **卡片操作**:
  - 编辑: 打开编辑策略弹窗
  - 回测: 直接跳转到创建回测任务向导
  - 查看详情: 进入策略详情页

---

## 2. 创建/编辑策略弹窗

### 弹窗布局
```
┌─────────────────────────────────────────────────────────────┐
│ 创建策略                                          [×]        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  策略名称 *                                                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 趋势跟踪策略                                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                               │
│  策略说明                                                     │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 基于双均线交叉的趋势跟踪策略，适用于期货市场...     │    │
│  │                                                       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                               │
│  标签                                                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ [#趋势] [#期货] [+ 添加标签]                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ ☑ 同时创建首个脚本版本                               │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                               │
│  ┌─ 脚本版本信息 ────────────────────────────────────┐      │
│  │                                                     │      │
│  │  版本号: v1.0.0  (自动生成)                        │      │
│  │                                                     │      │
│  │  版本描述                                           │      │
│  │  ┌───────────────────────────────────────────┐    │      │
│  │  │ 初始版本                                   │    │      │
│  │  └───────────────────────────────────────────┘    │      │
│  │                                                     │      │
│  │  策略脚本 *                                         │      │
│  │  ┌───────────────────────────────────────────┐    │      │
│  │  │ [📝 在线编写]        │    │      │
│  │  └───────────────────────────────────────────┘    │      │
│  │                                                     │      │
│  │  ☑ 设为主版本                                      │      │
│  │                                                     │      │
│  └─────────────────────────────────────────────────────┘      │
│                                                               │
│                                      [取消]  [创建策略]       │
└─────────────────────────────────────────────────────────────┘
```

### 交互说明
- **策略名称**: 必填，最多50字符
- **策略说明**: 可选，支持多行文本，最多500字符
- **标签**: 可添加多个标签，支持从已有标签中选择或创建新标签
- **同时创建首个脚本版本**: 勾选后展开脚本版本信息区域
- **版本号**: 系统自动生成（v1.0.0），不可编辑
- **策略脚本**: 支持上传.ts文件或点击在线编写打开Monaco编辑器
- **设为主版本**: 首个版本默认勾选

---

## 3. 策略详情页

### 页面布局
```
┌─────────────────────────────────────────────────────────────────┐
│ ← 返回列表    趋势跟踪策略                [编辑] [复制] [归档]   │
├─────────────────────────────────────────────────────────────────┤
│ [基本信息] [脚本版本] [回测历史]                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  基本信息                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 策略名称: 趋势跟踪策略                                   │   │
│  │ 标签: [#趋势] [#期货]                                    │   │
│  │ 创建人: 张三                                              │   │
│  │ 创建时间: 2025-10-15 14:30:22                            │   │
│  │ 更新时间: 2025-10-20 09:15:45                            │   │
│  │                                                           │   │
│  │ 策略说明:                                                 │   │
│  │ 基于双均线交叉的趋势跟踪策略，适用于期货市场。           │   │
│  │ 使用快速均线和慢速均线的交叉信号进行买卖判断...          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  当前主版本                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ v2.1.0 · 2025-10-20 [⭐主版本]                [查看代码] │   │
│  │ 优化了止损逻辑，提升了风险控制能力                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  快速操作                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ [🚀 创建回测任务] [📝 新建脚本版本] [📊 查看回测历史]   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 脚本版本 Tab

### 页面布局
```
┌─────────────────────────────────────────────────────────────────┐
│ ← 返回列表    趋势跟踪策略                [编辑] [复制] [归档]   │
├─────────────────────────────────────────────────────────────────┤
│ [基本信息] [脚本版本] [回测历史]                [+ 新建版本]     │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  脚本版本列表                                                     │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ v2.1.0 · 2025-10-20 09:15  [⭐主版本]    [查看] [设为主版本] │   │
│  │ 优化了止损逻辑，提升了风险控制能力                       │   │
│  │ 创建人: 张三                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ v2.0.0 · 2025-10-18 16:20              [查看] [设为主版本] │   │
│  │ 重构了信号生成逻辑，提升了代码可读性                     │   │
│  │ 创建人: 张三                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ v1.0.0 · 2025-10-15 14:30              [查看] [设为主版本] │   │
│  │ 初始版本                                                  │   │
│  │ 创建人: 张三                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 交互说明
- **新建版本**: 打开创建脚本版本弹窗
- **查看**: 在Monaco编辑器中查看代码（只读模式）
- **设为主版本**: 将该版本设为主版本，用于后续回测的默认选择

---

## 5. 创建/编辑脚本版本弹窗

### 弹窗布局（在线编写模式）
```
┌─────────────────────────────────────────────────────────────────┐
│ 新建脚本版本 - 趋势跟踪策略                          [×]         │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  版本号: v2.2.0  (自动生成)                                      │
│                                                                   │
│  版本描述                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 添加了动态止盈功能                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  策略脚本                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ // Monaco Editor                                         │   │
│  │ import { Strategy } from '@platform/backtest-sdk';      │   │
│  │                                                           │   │
│  │ export default class TrendFollowingStrategy             │   │
│  │   extends Strategy {                                     │   │
│  │                                                           │   │
│  │   async onBar(bar: Bar) {                                │   │
│  │     // 策略逻辑                                           │   │
│  │   }                                                       │   │
│  │ }                                                         │   │
│  │                                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ☑ 设为主版本                                                    │
│                                                                   │
│                                      [取消]  [保存版本]          │
└─────────────────────────────────────────────────────────────────┘
```

### 交互说明
- **版本号**: 系统自动递增生成，不可编辑
- **Monaco编辑器**: 支持TypeScript语法高亮、代码补全、错误提示
- **设为主版本**: 保存后将此版本设为主版本

---

## 6. 创建回测任务向导

### 步骤1: 选择策略与版本
```
┌─────────────────────────────────────────────────────────────────┐
│ 创建回测任务                                          [×]        │
├─────────────────────────────────────────────────────────────────┤
│ ① 选择策略  ② 配置数据  ③ 配置参数  ④ 确认提交                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  选择策略 *                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 趋势跟踪策略                                        ▼   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  选择脚本版本 *                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ v2.1.0 (主版本) - 优化了止损逻辑                   ▼   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  策略说明:                                                        │
│  基于双均线交叉的趋势跟踪策略，适用于期货市场...                │
│                                                                   │
│                                              [取消]  [下一步 →]  │
└─────────────────────────────────────────────────────────────────┘
```

### 步骤2: 配置数据源
```
┌─────────────────────────────────────────────────────────────────┐
│ 创建回测任务                                          [×]        │
├─────────────────────────────────────────────────────────────────┤
│ ① 选择策略  ② 配置数据  ③ 配置参数  ④ 确认提交                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  选择数据集 *                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ES期货1分钟数据 (2020-2024)                        ▼   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  交易时间级别 *                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  ○ 1分钟  ● 5分钟  ○ 15分钟  ○ 1小时  ○ 日线          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  回测时间区间 *                                                   │
│  ┌──────────────────────┐   至   ┌──────────────────────┐      │
│  │ 2023-01-01          │        │ 2023-12-31          │      │
│  └──────────────────────┘        └──────────────────────┘      │
│                                                                   │
│  交易时段配置 *                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ○ 全时段交易 (24小时)                                   │   │
│  │ ● 限制交易时段                                           │   │
│  │                                                           │   │
│  │   预设时段模板:                                          │   │
│  │   ○ RTH - 常规时段 (09:30-16:00 美东时间)              │   │
│  │   ○ ETH - 延时时段 (18:00-次日09:30 美东时间)          │   │
│  │   ● 自定义时段                                           │   │
│  │                                                           │   │
│  │   时段1: [09:30] - [16:00]  时区: [America/New_York ▼] │   │
│  │   [+ 添加时段] (支持多个不连续时段)                     │   │
│  │                                                           │   │
│  │   持仓处理:                                              │   │
│  │   ● 持仓可跨时段保持                                     │   │
│  │   ○ 时段结束自动平仓                                     │   │
│  │                                                           │   │
│  │   ℹ️ 非交易时段的行情数据不触发策略逻辑                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│                                        [← 上一步]  [下一步 →]    │
└─────────────────────────────────────────────────────────────────┘
```

### 步骤3: 配置资金与成本参数
```
┌─────────────────────────────────────────────────────────────────┐
│ 创建回测任务                                          [×]        │
├─────────────────────────────────────────────────────────────────┤
│ ① 选择策略  ② 配置数据  ③ 配置参数  ④ 确认提交                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  资金配置                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 初始资金 *                                               │   │
│  │ ┌───────────────────┐  USD                              │   │
│  │ │ 100000            │                                    │   │
│  │ └───────────────────┘                                    │   │
│  │                                                           │   │
│  │ 杠杆倍数                                                  │   │
│  │ ┌───────────────────┐  倍                               │   │
│  │ │ 1                 │                                    │   │
│  │ └───────────────────┘                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  交易成本                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 手续费率 *                                               │   │
│  │ ┌───────────────────┐  %                                │   │
│  │ │ 0.03              │                                    │   │
│  │ └───────────────────┘                                    │   │
│  │                                                           │   │
│  │ 滑点模型 *                                               │   │
│  │ ○ 固定滑点  ● 比例滑点  ○ 自定义                        │   │
│  │ ┌───────────────────┐  %                                │   │
│  │ │ 0.01              │                                    │   │
│  │ └───────────────────┘                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  风险约束 (可选)                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ☑ 启用风险约束                                           │   │
│  │   最大回撤限制: [20] %  (触发后强制平仓并终止回测)      │   │
│  │   单日最大亏损: [5] %   (触发后强制平仓并暂停当日交易)  │   │
│  │                                                           │   │
│  │ ℹ️ 风险约束由平台层面强制执行,策略脚本无需感知           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  策略自定义参数                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 快速均线周期: [10]                                       │   │
│  │ 慢速均线周期: [30]                                       │   │
│  │ 止损比例: [2] %                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ☑ 保存为预设配置  预设名称: [默认配置]                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│                                        [← 上一步]  [下一步 →]    │
└─────────────────────────────────────────────────────────────────┘
```

### 步骤4: 确认提交
```
┌─────────────────────────────────────────────────────────────────┐
│ 创建回测任务                                          [×]        │
├─────────────────────────────────────────────────────────────────┤
│ ① 选择策略  ② 配置数据  ③ 配置参数  ④ 确认提交                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  任务配置确认                                                     │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 策略信息                                                  │   │
│  │ • 策略名称: 趋势跟踪策略                                 │   │
│  │ • 脚本版本: v2.1.0                                       │   │
│  │                                                           │   │
│  │ 数据配置                                                  │   │
│  │ • 数据集: ES期货1分钟数据 (2020-2024)                    │   │
│  │ • 时间级别: 5分钟                                        │   │
│  │ • 回测区间: 2023-01-01 至 2023-12-31                     │   │
│  │ • 交易时段: 09:30 - 15:00                                │   │
│  │                                                           │   │
│  │ 资金与成本                                                │   │
│  │ • 初始资金: 100,000 USD                                  │   │
│  │ • 杠杆倍数: 1倍                                          │   │
│  │ • 手续费率: 0.03%                                        │   │
│  │ • 滑点模型: 比例滑点 0.01%                               │   │
│  │                                                           │   │
│  │ 风险约束                                                  │   │
│  │ • 最大回撤限制: 20%                                      │   │
│  │ • 单日最大亏损: 5%                                       │   │
│  │                                                           │   │
│  │ 策略参数                                                  │   │
│  │ • 快速均线周期: 10                                       │   │
│  │ • 慢速均线周期: 30                                       │   │
│  │ • 止损比例: 2%                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  任务名称 (可选)                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 趋势跟踪策略-5分钟-2023全年                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│                                        [← 上一步]  [提交任务]    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 回测任务列表页

### 页面布局
```
┌─────────────────────────────────────────────────────────────────┐
│ 回测任务                                        [+ 创建回测任务]  │
├─────────────────────────────────────────────────────────────────┤
│ 🔍 搜索任务名称/策略...  [状态 ▼]  [时间范围 ▼]  [排序 ▼]      │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 趋势跟踪策略-5分钟-2023全年                    [执行中 ⏱]   │   │
│ │ 策略: 趋势跟踪策略 v2.1.0 · 数据: ES期货 · 5分钟           │   │
│ │ 区间: 2023-01-01 ~ 2023-12-31                              │   │
│ │ 进度: ████████████░░░░░░░░░░ 50% (预计剩余 5分钟)         │   │
│ │ 创建: 张三 · 2025-10-23 10:30      [查看详情] [终止]      │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                   │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 趋势跟踪策略-15分钟测试                        [成功 ✓]     │   │
│ │ 策略: 趋势跟踪策略 v2.0.0 · 数据: ES期货 · 15分钟          │   │
│ │ 区间: 2023-06-01 ~ 2023-12-31                              │   │
│ │ 收益率: +15.3% · 夏普: 1.85 · 最大回撤: -8.2%             │   │
│ │ 创建: 张三 · 2025-10-22 14:20  耗时: 3分15秒              │   │
│ │                            [查看详情] [复制配置] [导出]    │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                   │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 均值回归策略-日线回测                          [失败 ✗]     │   │
│ │ 策略: 均值回归策略 v1.5.2 · 数据: 沪深300 · 日线           │   │
│ │ 区间: 2022-01-01 ~ 2023-12-31                              │   │
│ │ 错误: 数据加载失败 - 数据集不完整                          │   │
│ │ 创建: 李四 · 2025-10-22 09:45  耗时: 15秒                 │   │
│ │                            [查看详情] [重试] [复制配置]    │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                   │
│                          [1] 2 3 4 ... 10                        │
└─────────────────────────────────────────────────────────────────┘
```

### 状态说明
- **待执行**: 任务已提交，等待调度
- **队列中**: 任务在队列中等待Worker资源
- **执行中**: 正在执行，显示进度条
- **成功**: 执行完成，显示关键指标
- **失败**: 执行失败，显示错误信息
- **终止**: 手动终止

---

## 8. 回测任务详情页

### 页面布局（执行中状态）
```
┌─────────────────────────────────────────────────────────────────┐
│ ← 返回列表    趋势跟踪策略-5分钟-2023全年          [终止任务]   │
├─────────────────────────────────────────────────────────────────┤
│ [概览] [日志] [结果分析]                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  任务状态: [执行中 ⏱]                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 进度: ████████████░░░░░░░░░░ 50%                        │   │
│  │ 已处理: 180 / 360 天                                     │   │
│  │ 预计剩余时间: 5分钟                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  任务信息                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 任务ID: BT-20251023-001                                  │   │
│  │ 策略: 趋势跟踪策略 v2.1.0                                │   │
│  │ 数据集: ES期货1分钟数据                                  │   │
│  │ 时间级别: 5分钟                                          │   │
│  │ 回测区间: 2023-01-01 至 2023-12-31                       │   │
│  │ 创建人: 张三                                              │   │
│  │ 创建时间: 2025-10-23 10:30:15                            │   │
│  │ 开始时间: 2025-10-23 10:30:22                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  配置参数                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 初始资金: 100,000 USD                                    │   │
│  │ 手续费率: 0.03%                                          │   │
│  │ 滑点模型: 比例滑点 0.01%                                 │   │
│  │ 快速均线: 10 · 慢速均线: 30 · 止损: 2%                  │   │
│  │                                        [查看完整配置]    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  实时指标预览                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 累计收益率: +8.5%                                        │   │
│  │ 最大回撤: -3.2%                                          │   │
│  │ 交易次数: 45                                             │   │
│  │ 胜率: 62.2%                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 页面布局（成功状态 - 结果分析Tab）
```
┌─────────────────────────────────────────────────────────────────┐
│ ← 返回列表    趋势跟踪策略-15分钟测试    [复制配置] [导出报告]  │
├─────────────────────────────────────────────────────────────────┤
│ [概览] [日志] [基准报告] [因子分析]                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  绩效指标                                                         │
│  ┌────────────────┬────────────────┬────────────────┐          │
│  │ 累计收益率      │ 年化收益率      │ 最大回撤        │          │
│  │ +15.3%         │ +18.7%         │ -8.2%          │          │
│  ├────────────────┼────────────────┼────────────────┤          │
│  │ 夏普比率        │ 卡玛比率        │ 胜率            │          │
│  │ 1.85           │ 2.28           │ 58.3%          │          │
│  ├────────────────┼────────────────┼────────────────┤          │
│  │ 交易次数        │ 平均持仓时间    │ 收益波动率      │          │
│  │ 127            │ 2.3天          │ 10.1%          │          │
│  └────────────────┴────────────────┴────────────────┘          │
│                                                                   │
│  净值曲线                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                  ╱       │   │
│  │                                            ╱╲  ╱        │   │
│  │                                      ╱╲  ╱  ╲╱         │   │
│  │                                ╱╲  ╱  ╲╱               │   │
│  │                          ╱╲  ╱  ╲╱                     │   │
│  │ ─────────────────────────────────────────────────────  │   │
│  │ 2023-01      2023-04      2023-07      2023-10         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  交易明细                                      [导出CSV]          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 时间            方向  价格  数量  盈亏  因子标签          │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 2023-01-05 10:30  买入  4100  10   -    RSI:45,趋势:上升 │   │
│  │ 2023-01-08 14:15  卖出  4150  10  +500  RSI:68,趋势:上升 │   │
│  │ 2023-01-12 09:45  买入  4120  10   -    RSI:42,趋势:横盘 │   │
│  │ 2023-01-15 11:20  卖出  4080  10  -400  RSI:35,趋势:下降 │   │
│  │ ...                                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                          [1] 2 3 4 ... 13                        │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 因子分析 Tab

### 页面布局
```
┌─────────────────────────────────────────────────────────────────┐
│ ← 返回列表    趋势跟踪策略-15分钟测试    [复制配置] [导出报告]  │
├─────────────────────────────────────────────────────────────────┤
│ [概览] [日志] [基准报告] [因子分析]                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  因子分析视图                                   [+ 创建分析视图]  │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 📊 高波动率场景分析                        [编辑] [删除] │   │
│  │ 筛选条件: 波动率 > 0.02 AND RSI 在 30-70 之间            │   │
│  │ 交易笔数: 45 / 127 (35.4%)                               │   │
│  │ 累计收益: +22.5% | 夏普比率: 2.15 | 胜率: 64.4%         │   │
│  │                                          [查看详情] [对比] │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 📊 趋势市场分析                            [编辑] [删除] │   │
│  │ 筛选条件: 趋势 = '上升' AND 交易时段 = 'RTH'             │   │
│  │ 交易笔数: 38 / 127 (29.9%)                               │   │
│  │ 累计收益: +18.8% | 夏普比率: 1.92 | 胜率: 60.5%         │   │
│  │                                          [查看详情] [对比] │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 📊 RSI超卖区域分析                         [编辑] [删除] │   │
│  │ 筛选条件: RSI < 30                                       │   │
│  │ 交易笔数: 12 / 127 (9.4%)                                │   │
│  │ 累计收益: +8.2% | 夏普比率: 1.35 | 胜率: 58.3%          │   │
│  │                                          [查看详情] [对比] │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  选择视图对比: ☑ 高波动率场景  ☑ 趋势市场  ☐ RSI超卖区域       │
│                                                    [对比选中视图] │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 交互说明
- **创建分析视图**: 打开向导式创建流程
- **查看详情**: 展开该视图的完整分析报告（指标、图表、交易明细）
- **对比**: 勾选多个视图后，点击"对比选中视图"进入对比页面
- 每个视图卡片显示筛选条件、匹配的交易笔数和关键指标预览

---

## 10. 创建因子分析视图向导

### 步骤1: 选择筛选因子
```
┌─────────────────────────────────────────────────────────────────┐
│ 创建因子分析视图                                      [×]        │
├─────────────────────────────────────────────────────────────────┤
│ ① 选择因子  ② 设置条件  ③ 预览结果  ④ 生成报告                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  视图名称 *                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 高波动率场景分析                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  选择要筛选的因子                                                 │
│                                                                   │
│  自定义因子 (策略记录)                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ☑ RSI (数值型)                                           │   │
│  │ ☑ 波动率 (数值型)                                        │   │
│  │ ☑ 趋势 (分类型: 上升/下降/横盘)                         │   │
│  │ ☐ 入场原因 (分类型: 金叉/死叉/突破)                     │   │
│  │ ☐ 信心度 (数值型)                                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  系统默认因子                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ☑ 交易时段 (分类型: RTH/ETH)                            │   │
│  │ ☐ 交易时间 (时间型)                                      │   │
│  │ ☐ 星期几 (分类型: 周一~周日)                            │   │
│  │ ☐ 持仓时长 (数值型)                                      │   │
│  │ ☐ 账户净值 (数值型)                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  已选择 4 个因子                                                  │
│                                                                   │
│                                              [取消]  [下一步 →]  │
└─────────────────────────────────────────────────────────────────┘
```

### 步骤2: 设置筛选条件
```
┌─────────────────────────────────────────────────────────────────┐
│ 创建因子分析视图                                      [×]        │
├─────────────────────────────────────────────────────────────────┤
│ ① 选择因子  ② 设置条件  ③ 预览结果  ④ 生成报告                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  设置筛选条件                                                     │
│                                                                   │
│  条件组 1 (AND 逻辑)                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ RSI (数值型)                                             │   │
│  │ ○ 等于  ● 范围  ○ 大于  ○ 小于                         │   │
│  │ 最小值: [30]  最大值: [70]                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 波动率 (数值型)                                          │   │
│  │ ○ 等于  ○ 范围  ● 大于  ○ 小于                         │   │
│  │ 阈值: [0.02]                                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 趋势 (分类型)                                            │   │
│  │ ● 等于  ○ 不等于  ○ 包含                               │   │
│  │ 选择值: [上升 ▼]                                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 交易时段 (分类型)                                        │   │
│  │ ● 等于  ○ 不等于  ○ 包含                               │   │
│  │ 选择值: [RTH ▼]                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  [+ 添加条件组] (支持 OR 逻辑)                                   │
│                                                                   │
│                                        [← 上一步]  [下一步 →]    │
└─────────────────────────────────────────────────────────────────┘
```

### 步骤3: 预览筛选结果
```
┌─────────────────────────────────────────────────────────────────┐
│ 创建因子分析视图                                      [×]        │
├─────────────────────────────────────────────────────────────────┤
│ ① 选择因子  ② 设置条件  ③ 预览结果  ④ 生成报告                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  筛选条件预览                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ RSI 在 30-70 之间                                        │   │
│  │ AND 波动率 > 0.02                                        │   │
│  │ AND 趋势 = '上升'                                        │   │
│  │ AND 交易时段 = 'RTH'                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  匹配结果统计                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 总交易笔数: 127                                          │   │
│  │ 匹配笔数: 38 (29.9%)                                     │   │
│  │ 时间分布: 2023-01-15 至 2023-12-20                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  匹配交易预览                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 时间              方向    价格    盈亏    因子信息        │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 2023-01-15 10:30  买入    4120    +450   RSI:45,波动率:0.025 │
│  │ 2023-02-08 14:20  买入    4250    +380   RSI:52,波动率:0.028 │
│  │ 2023-03-12 11:15  买入    4180    +520   RSI:48,波动率:0.031 │
│  │ ...                                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ☑ 保存为筛选模板 (模板名称: [高波动率RTH场景])                  │
│                                                                   │
│                                        [← 上一步]  [生成报告]    │
└─────────────────────────────────────────────────────────────────┘
```

### 步骤4: 生成分析报告
系统自动计算并生成该视图的完整分析报告，返回因子分析Tab显示新创建的视图。

---

## 11. 因子分析视图详情页

### 页面布局
```
┌─────────────────────────────────────────────────────────────────┐
│ ← 返回任务详情    高波动率场景分析                [编辑] [导出]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  筛选条件                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ RSI 在 30-70 之间 AND 波动率 > 0.02                      │   │
│  │ AND 趋势 = '上升' AND 交易时段 = 'RTH'                   │   │
│  │ 匹配: 38 / 127 笔交易 (29.9%)                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  绩效对比 (视图 vs 基准)                                          │
│  ┌──────────────────┬──────────────┬──────────────┐            │
│  │ 指标              │ 当前视图      │ 基准报告      │            │
│  ├──────────────────┼──────────────┼──────────────┤            │
│  │ 累计收益率        │ +22.5%       │ +15.3%       │            │
│  │ 夏普比率          │ 2.15         │ 1.85         │            │
│  │ 最大回撤          │ -6.5%        │ -8.2%        │            │
│  │ 胜率              │ 64.4%        │ 58.3%        │            │
│  │ 平均持仓时间      │ 2.8天        │ 2.3天        │            │
│  └──────────────────┴──────────────┴──────────────┘            │
│                                                                   │
│  净值曲线对比                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │    ─── 当前视图  ─── 基准报告                           │   │
│  │                                                  ╱       │   │
│  │                                            ╱╲  ╱        │   │
│  │                                      ╱╲  ╱  ╲╱         │   │
│  │                                ╱╲  ╱  ╲╱               │   │
│  │                          ╱╲  ╱  ╲╱                     │   │
│  │ ─────────────────────────────────────────────────────  │   │
│  │ 2023-01      2023-04      2023-07      2023-10         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  交易明细                                      [导出CSV]          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 时间              方向    价格  数量  盈亏    因子信息    │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 2023-01-15 10:30  买入    4120  10   +450  RSI:45,波动率:0.025 │
│  │ 2023-02-08 14:20  买入    4250  10   +380  RSI:52,波动率:0.028 │
│  │ ...                                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 12. 多视图对比页面

### 页面布局
```
┌─────────────────────────────────────────────────────────────────┐
│ ← 返回任务详情    视图对比分析                         [导出]    │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  对比视图: [高波动率场景] vs [趋势市场] vs [基准报告]            │
│                                                                   │
│  关键指标对比                                                     │
│  ┌──────────────┬────────────┬────────────┬────────────┐       │
│  │ 指标          │ 高波动率    │ 趋势市场    │ 基准报告    │       │
│  ├──────────────┼────────────┼────────────┼────────────┤       │
│  │ 交易笔数      │ 38 (29.9%) │ 45 (35.4%) │ 127 (100%) │       │
│  │ 累计收益率    │ +22.5% ⬆️  │ +18.8% ⬆️  │ +15.3%     │       │
│  │ 夏普比率      │ 2.15 ⬆️    │ 1.92 ⬆️    │ 1.85       │       │
│  │ 最大回撤      │ -6.5% ⬆️   │ -7.1% ⬆️   │ -8.2%      │       │
│  │ 胜率          │ 64.4% ⬆️   │ 60.5% ⬆️   │ 58.3%      │       │
│  │ 平均盈亏比    │ 1.85       │ 1.62       │ 1.55       │       │
│  └──────────────┴────────────┴────────────┴────────────┘       │
│                                                                   │
│  净值曲线对比                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │    ─── 高波动率  ─── 趋势市场  ─── 基准                 │   │
│  │                                                  ╱       │   │
│  │                                            ╱╲  ╱        │   │
│  │                                      ╱╲  ╱  ╲╱         │   │
│  │                                ╱╲  ╱  ╲╱               │   │
│  │                          ╱╲  ╱  ╲╱                     │   │
│  │ ─────────────────────────────────────────────────────  │   │
│  │ 2023-01      2023-04      2023-07      2023-10         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  收益分布对比                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  高波动率   █████████░░  64.4% 胜率                     │   │
│  │  趋势市场   ████████░░░  60.5% 胜率                     │   │
│  │  基准报告   ███████░░░░  58.3% 胜率                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
│  分析结论                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • 在高波动率场景下,策略表现显著优于基准 (+7.2%)          │   │
│  │ • 趋势市场场景的收益提升相对较小 (+3.5%)                │   │
│  │ • 建议在高波动率市场环境下增加仓位配置                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 13. 交互流程图

### 创建策略流程
```
开始
  ↓
点击"创建策略"
  ↓
填写策略名称、说明、标签
  ↓
是否创建首个脚本版本？
  ├─ 是 → 上传/编写脚本 → 填写版本描述
  └─ 否 → 直接创建
  ↓
提交创建
  ↓
跳转到策略详情页
  ↓
结束
```

### 创建回测任务流程
```
开始
  ↓
点击"创建回测任务"或策略详情页"创建回测任务"
  ↓
步骤1: 选择策略和脚本版本
  ↓
步骤2: 配置数据源（数据集、时间级别、区间、时段）
  ↓
步骤3: 配置资金与成本参数（初始资金、手续费、滑点、风险约束、策略参数）
  ↓
步骤4: 确认配置信息
  ↓
提交任务
  ↓
跳转到任务详情页（显示执行进度）
  ↓
任务完成 → 查看结果分析
  ↓
结束
```

---

## 14. 响应式设计说明

### 桌面端（>1200px）
- 列表采用卡片式布局，每行1个卡片
- 详情页采用左右分栏布局
- 表单采用多列布局

### 平板端（768px - 1200px）
- 列表保持卡片式布局
- 详情页改为单列布局
- 表单改为单列布局

### 移动端（<768px）
- 列表改为紧凑卡片布局
- 隐藏次要信息，点击展开
- 表单采用垂直堆叠布局
- 向导步骤改为全屏模式

---

## 15. 颜色与状态标识

### 状态颜色
- **待执行**: 灰色 `#8C8C8C`
- **队列中**: 蓝色 `#1890FF`
- **执行中**: 橙色 `#FA8C16`
- **成功**: 绿色 `#52C41A`
- **失败**: 红色 `#F5222D`
- **终止**: 灰色 `#595959`

### 主版本标识
- 星标图标 ⭐ + 金色 `#FAAD14`

### 标签样式
- 圆角矩形，浅色背景，深色文字
- 支持自定义颜色分类

---

## 16. 关键交互细节

### 策略列表
- 支持拖拽排序（可选）
- 支持批量操作（归档、导出）
- 支持收藏/置顶功能

### Monaco编辑器
- 支持代码折叠
- 支持搜索替换
- 支持快捷键（Ctrl+S保存）
- 实时语法检查

### 回测任务向导
- 支持保存草稿
- 支持加载历史配置
- 支持参数预设模板
- 表单字段实时校验

### 结果分析
- 图表支持缩放、拖拽
- 支持导出图表为图片
- 支持对比多个任务
- 支持筛选特定时间段

---

## 17. 因子系统设计说明

### 因子类型

#### 1. 自定义因子（策略脚本记录）
策略开发者在交易时可以记录任意自定义因子：

**数值型因子**：
- RSI、MACD、布林带位置等技术指标
- 波动率、成交量相对强度等市场特征
- 信心度、预期收益等策略内部计算值

**分类型因子**：
- 趋势方向（上升/下降/横盘）
- 市场状态（震荡/趋势/突破）
- 入场原因（金叉/死叉/突破/回调）

#### 2. 系统默认因子（平台自动采集）

**时间维度因子**：
- 交易日期、交易时间
- 星期几（周一~周日）
- 月份、季度
- 交易时段（RTH/ETH）

**持仓相关因子**：
- 持仓时长（分钟/小时/天）
- 持仓盈亏金额
- 持仓盈亏比例

**账户状态因子**：
- 账户净值
- 可用资金
- 持仓市值占比
- 当前回撤比例

**市场环境因子**：
- 当前价格
- 成交量
- 价格波动率（可选）

### 因子记录时机

**开仓时记录入场因子**：
```typescript
this.buy(bar.close, 10, {
  factors: {
    rsi: 45,
    volatility: 0.025,
    trend: 'uptrend',
    entryReason: 'golden_cross',
    confidence: 0.85
  }
});
```

**平仓时记录出场因子**：
```typescript
this.sell(bar.close, 10, {
  factors: {
    rsi: 68,
    volatility: 0.018,
    trend: 'uptrend',
    exitReason: 'take_profit',
    holdingDays: 3
  }
});
```

### 因子存储结构

每笔交易记录包含：
```json
{
  "tradeId": "T-20230115-001",
  "timestamp": "2023-01-15T10:30:00Z",
  "direction": "buy",
  "price": 4120,
  "quantity": 10,
  "pnl": 450,
  "customFactors": {
    "rsi": 45,
    "volatility": 0.025,
    "trend": "uptrend",
    "entryReason": "golden_cross"
  },
  "systemFactors": {
    "tradingSession": "RTH",
    "dayOfWeek": "Monday",
    "accountEquity": 105450,
    "holdingPeriod": 4320  // 分钟
  }
}
```

### 因子分析能力

**筛选维度**：
- 单因子筛选：RSI > 50
- 多因子组合：RSI 在 30-70 AND 波动率 > 0.02
- 逻辑组合：(趋势='上升' OR 趋势='突破') AND 时段='RTH'

**分析输出**：
- 筛选后的交易子集统计指标
- 与基准报告的对比分析
- 多个视图之间的横向对比
- 识别最优因子组合

### 实现优势

- ✅ **灵活性**: 策略可记录任意因子，不受限制
- ✅ **完整性**: 系统自动补充通用因子
- ✅ **可追溯**: 每笔交易都有完整的因子快照
- ✅ **可分析**: 支持多维度筛选和对比分析

---

## 18. 风险约束实现说明

### 执行机制
风险约束采用**平台层面强制执行**的方案，由回测引擎在外层监控和执行，策略脚本无需感知风险约束的存在。

### 约束类型与触发行为

#### 1. 最大回撤限制
- **定义**: 账户净值从最高点回落的最大百分比
- **触发条件**: 当前回撤 ≥ 设置的最大回撤限制
- **触发行为**:
  - 立即强制平仓所有持仓
  - 终止回测任务
  - 记录风控触发事件
  - 任务状态标记为"成功(风控终止)"

#### 2. 单日最大亏损限制
- **定义**: 单个交易日内的最大亏损百分比
- **触发条件**: 当日亏损 ≥ 设置的单日最大亏损限制
- **触发行为**:
  - 立即强制平仓所有持仓
  - 暂停当日剩余时间的交易
  - 次日自动恢复交易
  - 记录风控触发事件

### 风控事件记录

所有风控触发事件会在以下位置记录：

1. **交易明细表**
   ```
   时间              类型      描述                    影响
   2023-06-15 14:30  风控触发  最大回撤限制(20%)      强制平仓,终止回测
   ```

2. **执行日志**
   ```
   [2023-06-15 14:30:15] RISK_CONTROL: 触发最大回撤限制
   [2023-06-15 14:30:15] RISK_CONTROL: 当前回撤 20.5% >= 限制 20%
   [2023-06-15 14:30:15] RISK_CONTROL: 强制平仓所有持仓
   [2023-06-15 14:30:15] RISK_CONTROL: 终止回测任务
   ```

3. **绩效报告**
   - 单独统计风控触发次数
   - 标注风控触发时的账户状态
   - 展示风控触发对整体收益的影响

### 实现优势

- ✅ **职责清晰**: 策略专注交易逻辑，平台负责风险控制
- ✅ **更安全**: 避免策略忽略或绕过风险约束
- ✅ **统一管理**: 所有策略使用相同的风控标准
- ✅ **可追溯**: 完整记录风控触发历史

---

> 本文档为UI交互设计草稿，具体实现时可根据技术栈和用户反馈进行调整。

