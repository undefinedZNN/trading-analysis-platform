# 回测策略管理模块需求更新日志

## 2025-10-26 重大更新

### 概述
基于产品讨论，对回测策略管理模块的需求进行了重要调整和功能增强。

---

## 一、策略管理简化

### 调整内容
**移除字段：**
- ❌ 策略编码（strategy_code）
- ❌ 团队归属（team）
- ❌ 适用市场/标的（applicable_markets）
- ❌ 交易频率（trading_frequency）
- ❌ 参数模板与实例化功能

**保留/新增字段：**
- ✅ 策略名称（必填）
- ✅ 策略说明
- ✅ 标签（用于分类检索）
- ✅ 回测脚本（可选，支持创建时上传或后续添加）
- ✅ 版本号（系统自动生成，如 v1.0.0）
- ✅ 创建人、更新时间（自动记录）

### 设计理念
- 策略管理专注于代码和逻辑
- 将交易时间级别、资金配置等移至回测执行配置
- 职责更清晰，使用更灵活

---

## 二、交易时段配置新增

### 功能概述
支持在回测任务配置时指定交易时段，策略可在不同时段测试效果。

### 核心特性

#### 1. 预设时段模板
- **RTH（Regular Trading Hours）** - 常规交易时段（如 09:30-16:00 美东时间）
- **ETH（Extended Trading Hours）** - 延时交易时段（如 18:00-次日09:30 美东时间）
- **全时段交易** - 24小时交易
- **自定义时段** - 用户自定义开始/结束时间和时区

#### 2. 多时段组合
- 支持配置多个不连续的交易时段
- 例如：RTH日间时段 + ETH晚间时段

#### 3. 持仓跨时段处理
- **采用方案**：持仓可跨时段保持
- **执行逻辑**：
  - 非交易时段：持仓保持，但不触发策略的 onBar 回调
  - 进入交易时段：继续持有，可以操作
  - 离开交易时段：继续持有，不可操作

#### 4. 实现机制
- 引擎层面根据配置过滤行情数据
- 仅在指定时段内调用策略逻辑
- 非交易时段的数据不会触发策略执行

### 使用场景
- 对比同一策略在 RTH vs ETH 的表现差异
- 测试仅在特定时段交易的效果
- 分析跨时段持仓的收益特征

---

## 三、风险约束执行机制明确

### 核心决策
采用**平台层面强制执行**方案，策略脚本无需感知风险约束。

### 约束类型

#### 1. 最大回撤限制
- **定义**：账户净值从最高点回落的最大百分比
- **触发行为**：
  - 立即强制平仓所有持仓
  - 终止回测任务
  - 记录风控触发事件
  - 任务状态标记为"成功(风控终止)"

#### 2. 单日最大亏损限制
- **定义**：单个交易日内的最大亏损百分比
- **触发行为**：
  - 立即强制平仓所有持仓
  - 暂停当日剩余时间的交易
  - 次日自动恢复交易
  - 记录风控触发事件

### 事件记录
所有风控触发事件在以下位置记录：
- 交易明细表（标记风控触发类型和影响）
- 执行日志（详细的风控触发过程）
- 绩效报告（统计风控触发次数和影响）

### 实现优势
- ✅ 职责清晰：策略专注交易逻辑，平台负责风险控制
- ✅ 更安全：避免策略忽略或绕过风险约束
- ✅ 统一管理：所有策略使用相同的风控标准
- ✅ 可追溯：完整记录风控触发历史

---

## 四、因子分析系统新增

### 功能概述
支持策略记录自定义因子，系统自动采集默认因子，基于因子数据创建多维分析视图。

### 因子类型

#### 1. 自定义因子（策略脚本记录）
策略可在交易时记录任意因子：

**数值型因子：**
- 技术指标：RSI、MACD、布林带位置等
- 市场特征：波动率、成交量相对强度等
- 策略计算：信心度、预期收益等

**分类型因子：**
- 趋势方向：上升/下降/横盘
- 市场状态：震荡/趋势/突破
- 入场原因：金叉/死叉/突破/回调

**实现方式：**
```typescript
this.buy(bar.close, 10, {
  factors: {
    rsi: 45,
    volatility: 0.025,
    trend: 'uptrend',
    entryReason: 'golden_cross',
    confidence: 0.85
  }
});
```

#### 2. 系统默认因子（平台自动采集）

**时间维度因子：**
- 交易日期、交易时间
- 星期几（周一~周日）
- 月份、季度
- 交易时段（RTH/ETH）

**持仓相关因子：**
- 持仓时长（分钟/小时/天）
- 持仓盈亏金额/比例

**账户状态因子：**
- 账户净值
- 可用资金
- 持仓市值占比
- 当前回撤比例

**市场环境因子：**
- 当前价格
- 成交量
- 价格波动率

### 因子分析视图

#### 概念
基于完整的回测任务交易数据，通过因子筛选条件创建多个分析视图，每个视图生成独立的分析报告。

#### 创建流程（向导式）
1. **选择筛选因子** - 从自定义因子和系统因子中选择
2. **设置筛选条件** - 配置数值范围、分类匹配、组合逻辑
3. **预览筛选结果** - 显示匹配的交易笔数和时间分布
4. **生成分析报告** - 系统自动计算该视图的完整指标

#### 筛选能力
- 单因子筛选：`RSI > 50`
- 多因子组合：`RSI 在 30-70 AND 波动率 > 0.02`
- 逻辑组合：`(趋势='上升' OR 趋势='突破') AND 时段='RTH'`

#### 分析输出
- 筛选后的交易子集统计指标
- 与基准报告的对比分析
- 净值曲线对比
- 交易分布差异

### 多视图对比

#### 功能
- 支持选择 2-4 个因子分析视图进行对比
- 并排展示各视图的关键指标
- 对比净值曲线、交易分布、胜率收益等差异
- 辅助识别策略在不同市场环境下的表现特征

#### 使用场景
- 分析"高波动率场景"vs"低波动率场景"的策略表现
- 对比"RTH时段"vs"ETH时段"的交易效果
- 识别"趋势市场"vs"震荡市场"的收益差异
- 找出最优因子组合条件

### 存储结构
每笔交易记录包含：
```json
{
  "tradeId": "T-20230115-001",
  "timestamp": "2023-01-15T10:30:00Z",
  "direction": "buy",
  "price": 4120,
  "quantity": 10,
  "pnl": 450,
  "customFactors": {
    "rsi": 45,
    "volatility": 0.025,
    "trend": "uptrend",
    "entryReason": "golden_cross"
  },
  "systemFactors": {
    "tradingSession": "RTH",
    "dayOfWeek": "Monday",
    "accountEquity": 105450,
    "holdingPeriod": 4320
  }
}
```

---

## 五、回测执行流程优化

### 配置结构调整

#### 原方案
```
策略属性:
  - 策略名称
  - 交易频率 ❌
  - 适用市场 ❌
  - 参数模板 ❌
```

#### 新方案
```
策略管理（策略创建）:
  - 策略名称
  - 策略说明
  - 标签
  - 回测脚本
  - 版本号

回测配置（任务创建）:
  - 选择策略及版本
  - 数据源配置
    - 选择数据集
    - 交易时间级别 ⭐ (移至此处)
    - 时间区间
    - 交易时段配置 ⭐ (新增)
  - 资金与成本配置
    - 初始资金
    - 手续费率
    - 滑点模型
    - 杠杆倍数
  - 风险约束 (可选)
    - 最大回撤限制
    - 单日最大亏损
  - 策略自定义参数
```

### 优势
- ✅ 同一策略可在不同时间级别测试
- ✅ 同一策略可在不同交易时段测试
- ✅ 策略代码与执行参数解耦
- ✅ 配置更灵活，复用性更强

---

## 六、UI/UX 设计更新

### 新增页面/组件

#### 1. 因子分析 Tab
- 位于回测任务详情页
- 与"概览"、"日志"、"基准报告"并列
- 显示所有创建的因子分析视图
- 支持创建、编辑、删除、对比视图

#### 2. 创建因子分析视图向导
- 4步向导式流程
- 实时预览筛选结果
- 支持保存筛选模板

#### 3. 因子分析视图详情页
- 显示筛选条件
- 绩效对比（视图 vs 基准）
- 净值曲线对比
- 交易明细（带因子标签）

#### 4. 多视图对比页面
- 关键指标对比表
- 净值曲线对比图
- 收益分布对比
- 自动生成分析结论

### 更新组件

#### 回测任务配置向导 - 步骤2 更新
新增交易时段配置区域：
- 预设时段模板选择
- 自定义时段配置
- 多时段组合
- 持仓处理方式选择

#### 回测任务配置向导 - 步骤3 更新
风险约束配置区域优化：
- 明确触发后的行为说明
- 添加提示：平台层面强制执行

#### 交易明细表更新
新增"因子标签"列：
- 显示该笔交易的关键因子
- 支持点击查看完整因子数据

---

## 七、技术架构更新

### 策略执行层增强

#### 交易时段控制
- 引擎根据配置过滤行情数据
- 仅在指定时段内调用策略 onBar
- 非交易时段持仓保持但不触发逻辑

#### 风险约束监控
- 平台层面实时监控账户状态
- 触发时强制平仓并记录事件
- 策略脚本完全无需感知

#### 因子采集
- 策略通过 SDK 记录自定义因子
- 引擎自动补充系统默认因子
- 统一存储用于后续分析

### 因子与指标聚合器增强
- 接收自定义因子和系统因子
- 建立索引支持快速筛选
- 支持因子分析视图的创建
- 根据筛选条件重新计算指标

### 结果存储扩展
- 每笔交易包含完整的因子快照
- 支持因子数据的快速筛选和聚合
- 存储因子分析视图配置和结果
- 支持多视图对比查询

### 数据与控制流更新
```
用户提交任务
  ↓
(包含交易时段、风险约束配置)
  ↓
Broker 初始化
  ↓
(创建时段过滤器、风险监控器)
  ↓
Worker 执行
  ↓
(时段过滤 + 风险监控 + 因子采集)
  ↓
Aggregator 聚合
  ↓
(累积指标 + 因子数据)
  ↓
任务完成
  ↓
(基准报告 + 风控记录)
  ↓
用户分析
  ↓
(创建因子视图 + 多视图对比)
```

---

## 八、实现优先级

### M1 优先级调整
- 策略管理简化 ⭐ 高优先级
- 交易时段基础实现 ⭐ 高优先级
- 风险约束基础实现 ⭐ 高优先级
- 因子采集框架 ⭐ 高优先级

### M2-M3 增强
- 交易时段多时段组合
- 风险约束完整事件记录
- 因子分析视图创建
- 系统默认因子完善

### M4 完整体验
- 因子分析向导优化
- 多视图对比完整实现
- 导出功能增强

---

## 九、文档更新清单

### 已更新文档
✅ `backtesting-strategy-management-prd.md` - 需求文档
✅ `wireframes.md` - UI交互设计文档
✅ `backtesting-system-architecture.md` - 技术架构文档
✅ `CHANGELOG.md` - 本更新日志

### 待更新文档
⏳ `backtesting-script-architecture.md` - 脚本架构（需补充因子API）
⏳ `development-plan.md` - 开发计划（需调整里程碑）

---

## 十、关键设计决策总结

| 问题 | 决策 | 理由 |
|------|------|------|
| 交易频率/时间级别配置位置 | 回测配置 | 同一策略可测试不同时间级别 |
| 交易时段模板 | 预设RTH/ETH + 自定义 | 灵活支持常见场景 |
| 时段结束持仓处理 | 持仓可跨时段保持 | 符合实际交易场景 |
| 风险约束执行方式 | 平台层面强制执行 | 职责清晰，更安全 |
| 因子分析UI交互 | 向导式创建 | 更直观易用 |
| 因子记录时机 | 开仓和平仓时都记录 | 分析入场和出场条件 |

---

## 十一、后续建议

### 短期优化
1. 补充因子 API 的详细设计
2. 更新开发计划的里程碑划分
3. 设计因子数据的存储索引策略
4. 编写因子分析的性能测试方案

### 长期扩展
1. 支持因子的自动发现和推荐
2. 基于机器学习的最优因子组合识别
3. 实时交易场景的因子监控
4. 因子数据的可视化探索工具

---

> 本次更新显著增强了系统的灵活性和分析能力，为量化研究提供了更强大的工具支持。

