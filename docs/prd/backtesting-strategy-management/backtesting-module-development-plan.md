# 交易回测模块开发计划

## 0. 规划说明
本开发计划覆盖交易回测模块在当前阶段的整体建设安排，并以“策略管理”作为首个落地里程碑。后续回测任务、交易结果分析等子功能将在本计划中继续扩展，形成统一的实施路线图。

## 1. 概述
基于《交易回测模块 PRD》及相关细化文档，制定本期可执行的开发任务安排。当前优先交付策略管理功能，确保策略脚本与 Schema 管理能力落地，为后续回测任务与交易结果分析提供数据基础。

## 2. 范围与优先级
- **阶段 0：基础建设（先行交付）**
  - 初始化回测模块后端服务骨架：模块化目录、配置管理、数据库连接、统一日志与错误处理。
  - 建立数据库迁移与本地开发基线（Docker Compose/Seed 数据、环境变量约定）。
  - 初始化前端回测模块入口：路由结构、Layout 容器、统一状态管理（Redux/RTK Query 或同类）、UI 主题扩展。
  - 共用工具与规范：API 调用封装、权限/鉴权占位、代码风格与测试脚手架。
- **阶段 1：策略管理（当前阶段）**
  - 策略列表与详情页（含标签、筛选、版本列表展示）。
  - 策略创建流程与脚本编辑器。
  - 脚本版本管理（自动生成、命名、master 标记、复制、对比）。
  - Schema 维护与校验流程。
  - 基础审计信息、回测任务引用信息联动。
- **阶段 2（预告）**：回测任务管理（待后续细化）。
- **阶段 3（预告）**：交易结果分析与因子筛选（待后续细化）。

当前计划默认阶段 0 与阶段 1 紧密衔接；后续阶段在需求完备后补充。

不包含：权限体系、通知/审批流程、版本导出功能、历史版本归档机制。

## 3. 前提依赖
- 阶段 0 将交付交易回测模块的基础框架（前端路由、API 模块、数据库连接等）。
- 策略 SDK 数据结构约定已初步确定（尤其是参数/因子 Schema 字段命名）。
- TypeScript 检查执行环境可在后端服务中运行（Bun Worker 或 Node 子进程）。

## 4. 角色与分工建议
- **后端开发 (BE)**：负责数据库结构、API、版本校验逻辑、后端 TS/ESLint 校验执行。
- **前端开发 (FE)**：负责页面与组件实现、轻量 Schema Renderer、版本对比 UI。
- **测试 (QA)**：制定测试用例、执行冒烟与回归测试。
- **产品/需求 (PM/PD)**：确认交互、验收标准，支持需求答疑。

## 5. 开发任务拆分

### 阶段 0：基础建设 ✅（已完成）

#### 5.0.1 后端任务
1. **服务骨架搭建** ✅
   - 在现有后端项目中创建回测模块（module/service/controller），约定命名空间与依赖注入结构。
   - 配置公共组件：日志（结构化输出）、配置中心、错误处理中间件、统一响应格式。
2. **数据库与迁移基线** ✅
   - 建立回测模块专用的数据库迁移目录与脚本模板（TypeORM Migration/Bun 等）。
   - 新增基础表：`strategies`、`script_versions` 的占位结构（仅主键/外键），为阶段 1 详细字段铺垫。
   - 提供本地开发的 Docker Compose 与 Seed 脚本，方便团队快速启动。
3. **工具库与安全基础** ✅（权限占位与错误码规范预留，后续迭代补充）
   - 抽象 API 授权/鉴权中间件占位，预留后续权限扩展点。
   - 约定 DTO 与实体映射规范，集成类验证器（class-validator）及统一错误码枚举。

#### 5.0.2 前端任务
1. **项目结构与路由** ✅
   - 在前端应用中新增回测模块根路由，配置懒加载入口、Breadcrumb 占位。
   - 创建通用 Layout（列表 + 详情两栏布局）与基础导航。
2. **基础组件与状态管理** ✅
   - 建立回测模块的 API 层封装（基于 RTK Query / Axios Hook），统一错误处理与 Loading 状态。
   - 约定全局状态切片或 Context，用于后续策略/回测数据共享。
3. **样式与主题**
   - 扩展 Ant Design 主题变量（色彩、尺寸）与模块内通用样式。
   - 设置 ESLint/Prettier/Stylelint 配置与提交钩子，确保代码质量一致。

#### 5.0.3 DevOps / QA 支撑
1. **持续集成配置**
   - 更新 CI 流程，增加回测模块相关测试命令、Lint、构建步骤。
   - 配置 Sonar 或代码质量扫描，确保后续迭代可持续监控。
2. **测试基线**
   - 准备 Postman/Thunder Collection 与前端 Mock 数据，便于阶段 1 开发联调。

### 阶段 1：策略管理

#### 5.1 后端任务
1. **数据库结构设计与迁移** ✅
   - 新增 `strategies`、`script_versions` 表，包含字段：标签数组（JSON/多对多）、版本号、代码、Schema、备注、创建/更新时间等。
   - 建立索引：策略名称唯一索引，脚本版本号唯一约束（策略范围），标签全文/GIN 索引（根据存储方案）。
   - 预留 `last_referenced_at` 字段供回测任务更新。
2. **策略管理 API** ✅
   - `GET /strategies`：支持名称、标签、创建人、时间范围筛选；包含分页。
   - `POST /strategies`：创建策略（含基础信息与初始脚本版本）。
   - `GET /strategies/:id`：返回策略详情、脚本版本列表。
   - `PATCH /strategies/:id`：更新基础信息（描述、标签）。
   - `POST /strategies/:id/script-versions`：保存新脚本版本（包含代码、Schema、版本号）。
   - `PATCH /strategies/:id/script-versions/:versionId`：更新版本号、备注、设为 master。
   - `POST /strategies/:id/script-versions/:versionId/copy`：复制版本生成草稿。
   - `GET /strategies/:id/script-versions/:versionId/diff`：返回与指定版本的差异（代码 + Schema）。
3. **标签管理**
   - 后端校验单策略最多 6 个标签，自动去重。
   - 提供 `GET /strategies/tags` 接口返回已有标签列表（供前端联想）。
4. **脚本校验服务**
   - 集成 TypeScript `tsc --noEmit` 与 ESLint 执行；封装为异步服务。
   - 校验失败时返回结构化错误（行号、列号、信息）。
   - 控制执行超时与资源限制，避免长时间阻塞。
5. **Schema 解析与校验逻辑** ✅
   - 在受控沙箱中执行脚本导出，解析参数/因子 Schema。
   - 校验字段唯一性、类型与组件映射关系、validator 格式；生成结构化错误信息。
   - 维护内置校验规则列表，供前端提示与运行时复用。
6. **回测任务联动**
   - 暴露接口供回测任务更新脚本版本 `last_referenced_at`。
   - 在策略详情返回最近引用的回测任务 ID 列表（最多 5 条）。

#### 5.2 前端任务
1. **页面结构与路由** ✅
   - 新建策略管理模块入口，配置策略列表页与详情页路由。
   - 左右分栏布局：左侧策略列表 + 筛选器，右侧详情面板。
2. **策略列表功能** ✅（已实现名称搜索、标签筛选、分页与详情抽屉，支持行内编辑入口）
   - 列表展示字段、分页、排序。
   - 筛选组件：名称搜索、标签多选、创建人选择器、时间范围。
   - 标签新增：输入新标签后提交到后端校验并提示结果。
3. **策略创建流程** ✅（当前实现：页面内弹窗收集名称/描述/标签及初始脚本，使用 Monaco 编辑器填写默认模版，成功后刷新列表并进入脚本版本管理）
   - 弹窗或单独页面收集基础信息。
   - 创建成功跳转脚本编辑器。
4. **脚本编辑器** ✅（已接入 Monaco 编辑器，支持版本新建/复制/编辑、设为 master；后续补充校验结果提示与 diff 详情）
   - 集成 Monaco Editor 或同类 TS 编辑器；支持语法高亮、格式化。
   - 保存时调用后端校验 API，并展示校验结果。
   - 保存成功后支持版本号 inline 编辑与备注填写。
5. **Schema 预览组件** ✅（策略详情提供展开视图，弹窗与版本对比均复用）
   - 参数/因子共用组件，以只读方式展示解析后的字段详情。
   - 提供字段分组、类型/默认值/校验说明等信息，便于检视。
   - 内置常见组件/校验规则说明，指引脚本编写。
6. **版本列表与操作**
   - 展示版本号、是否 master、创建时间、备注、最近引用信息。
   - 操作按钮：设为 master、复制、对比、查看详情。
7. **版本对比界面**
   - 代码 diff 视图（采用 diff 组件）。
   - Schema diff：按字段对比，支持高亮新增/删除/变更。
   - 选择对比版本时需防止自比自身。
8. **交互细节**
   - 页面离开前未保存提示。
   - 版本号编辑校验和错误提示。
   - 操作成功后的 toast/提示。

#### 5.3 测试任务
1. **测试用例编写**
   - 策略创建/编辑/标签管理。
   - 版本保存、命名规则、master 切换。
   - 复制版本与对比功能。
   - Schema 解析与展示。
   - API 错误处理（校验失败、重复名称、标签超限等）。
2. **自动化测试**
   - 后端单元测试覆盖脚本校验、Schema 校验、版本管理逻辑。
   - 集成测试：主要 API 流程。
   - 前端组件单元测试（Schema Renderer）与 E2E 关键流程测试。

#### 5.4 文档与交付
- 更新《策略管理功能需求》中的接口规格（若有调整）。
- 编写 API 文档（Swagger 或 Markdown）。
- 提供使用指南：如何创建策略、保存版本、设置 master。
- 交付演示 Demo，收集反馈。

## 6. 里程碑与时间预估（阶段 0-1 示例）
| 里程碑 | 任务 | 负责人 | 预计耗时 |
| --- | --- | --- | --- |
| M0 | 基础建设交付（后端骨架、前端路由、CI 基线） | BE + FE + DevOps | 1 周 |
| M1 | 数据库迁移 & 核心 API 实现 | BE | 1.5 周 |
| M2 | 前端页面框架 & 列表功能 | FE | 1 周 |
| M3 | 脚本编辑器 + Schema Renderer | FE + BE | 2 周 |
| M4 | 版本管理操作与对比 | FE + BE | 1 周 |
| M5 | 联调 & 测试 | FE + BE + QA | 1 周 |
| M6 | 文档 & Demo | 全体 | 0.5 周 |

（注：时间预估需结合团队实际情况调整，可采用并行开发以缩短整体周期。）

## 7. 风险与缓解
- **TS 校验耗时**：需监控校验执行时间，必要时做缓存或异步处理。
- **Schema 复杂度**：初期控制字段数量，避免需求膨胀；提供预设模板。
- **版本历史膨胀**：监控用户行为，后续设计归档策略。
- **标签泛滥**：通过标签列表接口限制重复及脏数据，后续考虑标签管理后台。

## 8. 下一步建议
- 召开任务启动会议，确认分工与时间节点。
- 制定迭代计划（Sprint）并在看板中拆具体 issue。
- 阶段 0 完成后组织技术评审，确认基础设施满足策略管理开发需求。
- 先实现核心闭环（策略创建 → 保存版本 → 设置 master → 回测任务引用），再补充对比/复制等增强功能。

## 9. 后续规划（预留）
- 回测任务管理与调度（阶段 2）。
- 交易结果分析与因子筛选（阶段 3）。
- 权限体系与审计、并发回测、通知等增强能力（长期规划）。
