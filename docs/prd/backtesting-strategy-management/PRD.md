# 交易回测模块 PRD

## 相关文档
- 《交易数据管理模块 PRD》：`docs/prd/trading-data-management/trading-data-management-prd.md`
- 交易脚本 SDK 设计（待补充）：`docs/architecture/strategy-sdk.md`（预留）
- 回测系统架构设计文档（待重写）

## 背景
现有平台已经完成交易数据管理模块，支持统一导入与维护高质量的 OHLCV 历史数据。下一阶段需要建设交易回测模块，提供策略脚本管理、回测任务调度执行以及回测结果可视化分析的全链路能力。目标是在初始阶段就确保策略脚本可控、回测任务可追踪、回测结果包含逐笔交易与交易因子，以便后续扩展因子分析和多任务对比。

## 目标
- 提供 TypeScript 策略脚本的管理能力，含版本控制、对比、复制与 `master` 版本标记。
- 支撑用户创建回测任务：选择数据集、策略脚本版本、脚本自定义参数，提交后可运行、暂停、重试。
- 将任务执行过程中产生的逐笔交易明细、系统因子和脚本自定义因子沉淀至 DuckDB + Parquet，支持针对因子条件的结果分析。
- 提供交易结果分析视图，展示基础绩效指标、收益曲线与筛选后的指标，支持通过因子过滤调整分析输出。
- 建立与交易数据管理模块的衔接，确保仅可选择已清洗完成的数据集。

## 不在本阶段范围
- 自动化批量回测、数据切片并行回测（未来迭代）。
- 多用户/多角色差异化权限设计（当前阶段视为统一用户角色）。
- 与生产交易系统的自动部署、联动执行。
- 高级告警、通知与权限审计（仅记录必要日志）。

## 用户角色
- **量化策略使用者**（统一角色）：既负责编写/维护策略脚本，也负责发起回测任务并分析结果。后续如需引入运营/风控角色再补充。

## 核心概念
- **策略（Strategy）**：包含元信息与一套 TypeScript 回测脚本，策略层面不维护版本号。
- **策略脚本版本（Script Version）**：每次保存脚本时自动生成的版本记录，直接包含当时的完整源码、自定义参数与因子 Schema；可在版本列表中标记一个版本为 `master` 并用于默认回测。
- **自定义参数**：策略在脚本中声明的可配置变量，提交任务时需填写，支持类型、校验、默认值与表单渲染信息。
- **自定义因子**：策略运行时通过 SDK 输出的交易因子，用于回测结果分析中的筛选与聚合。
- **系统因子**：平台默认记录的交易因子，如交易时段、持仓时长、前 N 根 K 线重叠度等，可扩展。
- **回测任务（Backtest Task）**：以某个策略的脚本版本 + 数据集 + 参数配置发起的执行实例，拥有独立的状态机与结果存储。
- **交易结果分析视图**：基于任务输出的交易明细与因子数据，通过筛选条件计算出的指标快照与图表。

## 关键流程
1. **策略管理流程**
   - 创建策略：填写基本信息，上传/编辑 TypeScript 脚本，声明自定义参数与因子 Schema。
   - 脚本版本维护：保存新版本、对比差异、复制已有版本并设定为 `master`。
2. **回测任务流程**
   - 用户在回测任务列表页点击“新建回测”，选择一个策略脚本版本（默认选中 `master`）、目标数据集和执行配置。
   - 前端根据脚本版本附带的参数 Schema 动态渲染表单并执行输入校验。
   - 提交后任务进入状态机：`submitted` → `queued` → `running` → `completed`/`failed`/`cancelled`，可在 `queued`、`running` 状态时暂停或终止。
3. **执行与监控流程**
   - Orchestrator 校验配置并写入任务记录，投递至调度队列。
   - Execution Broker 拉取任务，分配 Worker，执行脚本并持续回传日志、进度与因子数据。
4. **交易结果分析流程**
   - 任务完成后生成默认结果分析：收益率、收益曲线、最大回撤、盈亏比等。
   - 用户可在分析页使用系统因子或脚本自定义因子过滤交易明细，实时刷新指标与图表。
   - 支持保存因子筛选视图并导出交易明细/指标。

## 功能需求概述

### 策略管理
- 策略列表：分页展示策略名称、描述、创建时间、最近更新的脚本版本号、`master` 版本标记、最近回测任务状态。
- 策略详情：
  - 查看脚本版本列表，支持按创建时间排序。
  - 每次保存脚本即自动生成一个新的脚本版本记录，无需单独创建操作。
  - 新建脚本版本或复制已有版本；复制时可选择是否继承参数/因子 Schema。
  - 设置某个脚本版本为 `master`（需二次确认）。
  - 查看脚本版本差异（源码对比 + Schema 对比）。
- 策略编辑器：
  - TypeScript 在线编辑或通过上传文件导入（保存后进行类型检查）。
  - 在脚本中声明自定义参数/因子 Schema：字段包括 `key`、`label`、`desc`、`type`、`component`、`enumOptions`（可选）、`defaultValue`、`validator`（函数或规则描述）。
  - 当前版本不处理多语言，`label` 与 `desc` 直接使用固定文案。
  - 前端使用自研的轻量级 Schema Renderer 渲染这些字段，Schema 字段命名保持与 Formily 兼容，后续若需要可平滑接入完整 Formily 能力。
  - 编辑器需支持校验 Schema 完整性，保存时写入版本记录。

### 回测任务管理
- 任务列表：
  - 列字段：任务 ID、策略名称 + 脚本版本、数据集、提交时间、发起人、当前状态、最新更新时间、收益率快照（完成后）。
  - 支持筛选：策略、脚本版本、状态、提交时间范围、数据集标签。
  - 行内操作：查看详情、复制任务配置、终止/暂停/继续运行。
- 新建任务：
  - 选择数据集（来自交易数据管理模块，仅显示状态为“清洗完成”的数据集）。
  - 选择策略脚本版本（默认 `master`，可切换其他版本）。
  - 动态表单展示脚本自定义参数；根据 `type` 和 `component` 渲染，如 `number`, `select`, `checkbox` 等，遵循 Schema 校验。
  - 配置执行选项（交易时段、初始资金、滑点、费用等，先定义 MVP 必须字段，可扩展）。
  - 提交后展示任务状态页，含进度条、实时日志、预计耗时（基于历史）。
- 任务状态与操作：
  - 状态枚举：`submitted`、`queued`、`running`、`paused`、`completed`、`failed`、`cancelled`。
  - 支持从 `queued`/`running` 切换到 `paused` 或 `cancelled`；`paused` 可恢复到 `queued`。
  - 失败时展示错误日志，提供重新提交入口（保留参数）。

### 交易结果分析
- 默认分析视图：
  - 基础指标：累计收益率、年化收益率、最大回撤、盈亏比、胜率、夏普比率等。
  - 图表：收益曲线、回撤曲线、净值曲线，后续可扩展因子散点图。
  - 回测概要：策略脚本版本、数据集信息、参数快照、执行耗时。
  - K 线复盘：支持加载关联数据集的 K 线图，并在图上标记开平仓点、盈亏、系统/自定义因子摘要，为后续图形化分析奠定基础。
- 交易明细：
  - 以表格展示每笔交易，字段包含：交易ID、时间、方向、数量、价格、盈亏、持仓时长、系统因子、自定义因子（按类别展开）。
  - 支持导出原始交易明细（CSV/Parquet）。
- 因子筛选：
  - 系统因子预设：交易时间段（如 09:00-10:00）、持仓 K 线数（>=5）、前 N 根 K 线重叠度、ART、IBS 等，可配置扩展。
  - 脚本自定义因子：根据脚本版本声明的因子 Schema 动态生成筛选器，支持多条件组合（AND/OR 规则 MVP 可先实现 AND）。
  - 表单渲染与回测任务创建共用同一套轻量 Schema Renderer 与组件映射，保证 Schema 定义一次即可在参数录入与因子筛选场景复用。
  - 筛选后的结果需实时更新指标、图表与交易明细，并可保存为“分析视图”快照。
- 分析视图：
  - 用户可保存筛选条件与生成的指标，命名并存档。
  - 支持对比多个分析视图（至多 3 个）并展示差异。

### 数据与依赖关系
- 逐笔交易数据需回写至可供交易结果分析读取的存储（DuckDB + Parquet 将在后续架构文档明确），字段包括交易基础信息、系统因子、自定义因子、参数快照引用。
- 因子元数据需与脚本版本绑定，确保回测结果的筛选器与策略声明一致。
- 回测任务必须与交易数据管理模块中状态为“清洗完成”的单一数据集关联，禁止跨多个数据集。

## 交互说明
- 策略列表与详情遵循中后台布局：左侧列表 + 右侧详情/编辑器。
- 版本对比使用左右分栏或折叠对比模式，突出参数/因子 Schema 的差异。
- 回测任务列表支持实时刷新（默认轮询 5 秒）。任务详情页展示状态时间轴、进度条、日志区、关键指标预览。
- 交易结果分析页结构：顶部指标卡、中部曲线图、下方交易明细与因子筛选侧栏。
- 动态表单与筛选器均基于 JSON Schema + UI 扩展字段生成，保持与架构设计一致的 `x-ui`/`x-filter` 约定。
