# 交易策略回测平台需求框架

## 文档目的
为交易策略回测平台的需求梳理提供顶层结构，指导后续分模块深入讨论与拆解，实现与交易数据管理模块的紧密衔接。

## 核心愿景与目标
- 支持量化团队快速验证策略假设，缩短从策略构想到绩效验证的闭环时间。
- 复用交易数据管理模块中已上传的数据集，形成统一的数据底座。
- 提供灵活的自定义策略脚本执行、因子筛选与多维绩效分析能力。
- 为未来的参数调优、实时仿真和自动化部署奠定基础。

## 角色与核心使用场景
- **量化策略开发者**：上传/迭代策略脚本，调用历史数据完成批量回测，查看回测结果与因子表现。
- **量化研究分析师**：在已有回测结果基础上进行因子筛选、比较不同条件下的收益表现，并导出分析报告。
- **平台管理员/运维**：维护策略执行环境、监控回测任务、管理资源与权限。

## 功能模块总览

### 1. 策略脚本管理
- 脚本上传：支持用户上传自定义回测脚本，规范文件结构、依赖声明与安全沙箱。
- 策略版本：策略迭代版本追踪、变更记录、回滚能力。
- 模板与 SDK：提供标准策略模板/SDK，约定回测入口、因子注册与指标输出接口。

### 2. 数据接入与准备
- 数据选择：与交易数据管理模块对接，支持按数据集、时间区间、标的物、粒度选择。
- 数据缓存：回测前的数据预处理、缓存策略（例如 K 线聚合、指标预计算）。
- 数据权限：基于用户/团队的数据访问控制，确保敏感数据隔离。

### 3. 回测执行引擎
- 运行模式：支持单次回测、批量参数组合任务；规划异步队列执行。
- 撮合模拟：配置手续费、滑点、成交规则、仓位限制等。
- 资源管理：执行资源隔离、任务优先级、运行超时与失败重试策略。
- 日志与审计：结构化运行日志、调试信息、异常事件追踪。

### 4. 回测结果分析
- 核心指标：收益率、最大回撤、Sharpe、Calmar、胜率、交易频次等。
- 报表输出：回测结果概览、收益曲线、回撤曲线、仓位变化、订单流水。
- 结果留存：回测记录查询、标签与备注、结果对比（按策略版本或参数集）。

### 5. 因子筛选与洞察
- 因子注册：脚本中可声明因子（例如“K 线重叠率”），平台识别并存储因子数据。
- 因子筛选：按照因子条件（阈值、区间、分位数）过滤样本，统计胜率、收益、回撤等表现。
- 因子分析可视化：因子分布、收益贡献、条件组合比较。
- 因子数据导出：支持导出筛选结果或供外部工具进一步建模。

### 6. 平台与系统能力
- 权限与安全：脚本执行沙箱、资源隔离、敏感配置管理。
- 接口与集成：回测任务 API、Web 控制台、任务状态通知、与现有 CI/CD 或调度系统对接。
- 可扩展性：多语言脚本支持规划、实时仿真/纸上交易、自动化部署的路线图占位。

## 架构设计参考
- 回测引擎的详细架构设计已独立整理，参见 `docs/architecture/trading-backtesting-engine.md`。

## 非功能性关注点
- 性能：大数据集回测的处理能力、任务并发承载、指标计算效率。
- 稳定性：任务失败恢复、数据一致性、日志与监控。
- 安全性：脚本沙箱隔离、依赖白名单、访问控制与审计。
- 可维护性：模块化架构、可观测性、配置驱动的扩展空间。

## 待确认问题（To Clarify）
- 与交易数据平台的接口形态（直接数据库访问、API、还是中间 SDK）。
- 初期目标回测规模（单策略？多策略并行？参数网格规模）。
- 回测结果展示渠道（仅 Web 控制台，还是需要导出 PDF/Excel 等）。
- 因子筛选的使用频率与复杂度（是否需要多因子组合、条件回测）。
- 资源预算与部署环境（单机、集群、云服务）。

## 下一步建议
1. 按模块组织需求访谈与原型研讨，补充功能细节与接口约定。
2. 产出策略脚本执行模型与数据访问设计草案。
3. 制定首批里程碑（MVP → 增强版 → 扩展能力），并与工程团队评估工期。

## 回测执行引擎需求初稿（讨论稿）

### 脚本运行时
- **脚本语言**：统一采用 TypeScript，提供标准 SDK（类型定义、工具函数、数据访问封装）以降低脚本编写成本。
- **构建与沙箱**：脚本上传后需经过编译/打包（`tsc` 或 esbuild）进入受控运行环境。限制文件系统与网络访问，仅暴露平台允许的模块与配置。
- **依赖管理**：提供白名单依赖列表或内置依赖包；后续扩展为 package descriptor（如 `package.json`）审批机制。

### 并发与任务调度
- **多线程执行**：核心引擎使用 Node.js Worker Threads 或基于进程池的方案，实现多实例并发回测，并控制 CPU/内存占用。
- **队列调度**：任务进入异步队列，支持优先级、并发上限、重试策略。考虑将因子计算/指标聚合拆分为后处理任务。
- **资源监控**：实时追踪任务状态、耗时、资源消耗，提供超时终止与失败告警。

### 数据与因子记录
- **数据注入**：回测任务读取交易数据管理模块的数据集，SDK 提供统一数据访问接口，支持按时间窗口、品种、粒度拉取。
- **策略输出**：脚本需使用 SDK 规范化地提交订单、记录指标、注册因子值；引擎负责捕获交易流水与账户状态。
- **因子体系**：
  - 自定义因子：策略脚本可动态注册任意因子（名称、说明、数据类型、计算逻辑），引擎在运行过程中记录因子取值。
  - 系统内置因子：平台提供基础因子库（如波动率、换手率、资金曲线特征），支持在回测配置中按需启用；需设计插件式扩展机制，便于后续迭代新增。
  - 因子采样：定义记录频率（逐笔、逐 K 线、逐信号）、存储格式（结构化时间序列），为后续筛选分析提供数据基础。

### 结果落地
- **指标存储**：每个任务保存策略绩效指标、因子统计摘要、订单流水、持仓快照。
- **查询接口**：提供任务级别的查询/筛选 API，支持按因子条件过滤结果，供因子筛选模块消费。
- **可追溯性**：记录脚本版本、运行参数、所用数据集版本，确保结果可复现。

### 架构协同计划
- **专家引入**：邀请具备交易回测系统经验的架构师参与评审与设计，明确顾问角色（参与周期、预期交付物、投入方式）。
- **需求澄清会**：安排 Kick-off，介绍数据平台现状、回测目标、因子体系诉求，收集架构师的风险提示与依赖假设。
- **架构设计产出**：由架构师牵头输出回测引擎宏观架构，包括组件划分、脚本沙箱方案、调度模型、数据流转示意。
- **评审与落地**：组织内部评审确认设计方案，形成里程碑拆解（MVP/增强版），并设立持续顾问窗口跟踪实现偏差。
