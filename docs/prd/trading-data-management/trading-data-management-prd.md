# 交易数据管理模块 PRD

## 相关文档
- 《交易数据导入与清洗设计》：`docs/architecture/data-import-pipeline.md`
- 《交易数据管理界面需求与交互设计》：`docs/architecture/data-import-product-requirements.md`

## 背景
平台需要统一管理来自多来源的 OHLCV 历史数据，以支撑回测、因子分析与策略验证。现阶段导入任务由研究或运营人员手动执行，文件规格大、格式多样。我们需要提供一个 Web 中后台界面，让用户可以完成数据导入、查看清洗进度、维护元数据并执行软删除/恢复操作。

## 目标
- 提供单文件的手动导入流程，覆盖上传、清洗进度追踪与结果呈现。
- 支持用户在列表中查询、筛选和维护已清洗的数据集。
- 实现软删除及恢复机制，确保数据在清洗完成后维持可追溯性。
- 保障元数据（来源、交易对、时间范围、自定义标签等）的可维护性和一致性。

## 不在本阶段范围
- 自动调度或批量导入。
- 用户权限与审计日志。
- 物理删除 Parquet 数据文件。
- 大文件断点续传与分块上传优化。

## 用户角色
- **量化研究/运营人员**：需要导入数据、关注处理进度、维护元数据。
- **数据工程人员（次要）**：关注数据质量、排查导入失败。

## 关键流程
1. 用户进入交易数据管理列表页，浏览或筛选既有数据集。
2. 点击“导入数据”，填写基础信息（来源、交易对、时间粒度、时间范围、标签）并上传文件。
3. 提交后停留在页面，实时查看上传与清洗进度；可随时返回列表页。
4. 列表页展示导入任务状态和进度条，支持刷新获取最新状态。
5. 完成导入后，用户可编辑描述与标签、或软删除数据集；软删除记录可通过过滤项恢复。

## 功能需求概述

### 数据列表
- 分页展示已导入数据集，默认按 `created_at` 倒序，仅显示未删除数据。
- 支持筛选：来源、交易对、时间粒度、数据时间范围（包含查询）、创建时间范围、自定义标签、状态（含“已删除”）。
- 列字段：`dataset_id`、来源、交易对、时间粒度、时间范围、记录数、自定义标签、状态、创建时间、（查看已删除时）删除时间。
- 行内操作：编辑元数据、软删除、恢复（仅已删除时可见）、查看详情入口（待后续扩展）。

### 导入流程
- 表单字段：来源（可选）、交易对（必填），时间粒度（必填）、时间范围（可选）、标签/描述（标签支持推荐列表与自由输入，单个标签 ≤25 字，自动去重）、数据文件（必填，支持 zst/CSV/JSON，暂无限制大小）。
- 表单提交后进入进度页：展示上传进度、清洗进度、阶段描述与最新日志片段，同时允许返回列表。
- 导入状态：`pending`、`uploading`、`processing`、`completed`、`failed`。状态与进度从 `imports` 表获取，可采用 5 秒轮询（默认方案，后续可扩展 WebSocket）。
- 成功后显示数据集编号与返回入口；失败时展示错误原因，并提供完整错误日志查看（滚动、复制）；用户可直接重新上传并触发一次新的清洗流程（默认保留表单填入信息）。

### 元数据维护与软删除
- 编辑：侧栏/弹窗修改描述、备注、自定义标签（去除首尾空格并去重）。
- 软删除：二次确认后写入 `deleted_at`，列表移除该记录；“显示已删除”筛选项开启后，可查看并执行恢复操作（恢复即清空 `deleted_at`）。
- 恢复成功后记录重新回归正常状态并出现在默认列表。

## 数据与状态依赖
- 依赖 `datasets` 表（参见《交易数据导入与清洗设计》）提供的数据集元信息、删除标志、自定义标签。
- 依赖 `imports` 表提供导入进度、状态及完整错误日志。
- 自定义标签存储在 `datasets.labels` JSONB 字段，需要后端对输入标签进行裁剪、去重与长度校验。

## 交互说明
- 列表页与导入页的详细组件布局、文案、状态色彩规范参见《交易数据管理界面需求与交互设计》。
- 进度页采用实时百分比展示，并输出当前阶段的文本描述。
- 删除与恢复操作均需弹出确认对话框，说明影响范围。

## 技术约束与实现提示
- 前端需支持单文件上传，文件上传成功后再提交清洗任务，后端统一处理格式检测与插件调用。
- 标签推荐列表可通过配置或接口返回，前端在自由输入时做去重处理。
- 列表页轮询导入状态的频率可通过配置调整，建议默认 5 秒。
- 后端实现软删除时，所有查询接口默认过滤 `deleted_at IS NULL`，并支持传参显示已删除记录。
- 数据库迁移及表结构管理统一使用 NestJS TypeORM migration 能力；错误日志字段需支持存储大文本。

## 数据指标 & 监控
- 需要记录导入任务的开始/结束时间、进度、结果，以便后续监控。
- 可在后续迭代中接入更完整的日志与告警机制（参见相关架构文档）。

## 开发里程碑建议
1. **MVP**：实现列表查询、导入表单 + 进度、元数据编辑、软删除/恢复。
2. **增强**：增加任务详情页、导入结果通知、批量操作。
3. **后续规划**：权限体系、自动化导入、历史日志与监控面板。

## 待确认事项
- 列表展示是否需要导入失败任务的详细错误日志弹窗。
- 文件上传成功后是否需要返回下载凭证或校验值给用户确认。
- 手绘交互稿产出后是否需要数字化重构为高保真原型。

如需详细交互草图与 API 定义，请参阅或补充对应设计与技术文档。手绘交互稿存放于 `docs/prd/trading-data-management/design-interactions/` 目录。
