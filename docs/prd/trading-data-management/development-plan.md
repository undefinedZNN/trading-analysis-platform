# 交易数据管理开发节奏建议

## 文档目的
指导团队分阶段推进交易数据管理模块的研发，同时作为后续迭代验收与复盘的依据。本计划可与迭代规划或看板同步维护。

## 推荐存放位置
- 本文档位于 `docs/prd/trading-data-management/`，便于与 PRD、API 草案、交互稿同目录管理。
- 若团队使用项目管理工具（如 Jira、Notion），可链接此文档并保持内容同步。

## 阶段划分

### Milestone 0：准备阶段（~1 周）
- 沉淀开放问题结论：列表错误日志弹窗 + 文本下载、失败重试沿用 7 天内保留的原始文件、原始文件统一落在 `raw_uploads/{importId}/` 并记录 `imports.source_file`。
- 输出手绘交互稿（存放于 `design-interactions/`），确认关键页面布局。
- 完成 API 草案审阅，锁定字段与响应格式。
- 搭建数据库迁移基础设施（NestJS TypeORM）。

### Milestone 1：MVP 实现（~2-3 周）
- 后端：
  - 实现 `datasets`、`imports` 实体与迁移，包含软删除与错误日志字段。
  - 完成导入流程（上传、异步清洗、状态更新、错误日志记录）。
  - 提供列表查询、状态查询、重试接口。
- 前端：
  - 搭建交易数据管理列表页，包含筛选、分页、状态展示。
  - 实现导入表单、上传流程与进度轮询。
  - 支持错误日志查看、重新导入，以及标签多选输入。
- 测试：
  - 覆盖导入成功、上传失败、清洗失败重试的端到端用例。

### Milestone 2：增强与稳定（~2 周）
- 增加导入任务详情页、错误日志下载。
- 支持列表“显示已删除”并实现恢复操作。
- 提升监控与告警（导入超时、失败提醒）。
- 前后端分别补充集成测试、E2E 测试。

### Milestone 3：扩展规划（待定）
- 规划权限管理、批量导入、自动化调度等高级功能。
- 如后续有全新交互诉求，再评估是否需要将手绘交互稿升级为高保真设计（当前阶段不计划推进）。

## 节奏建议
- 每个 Milestone 结束前召开评审，确认交付物与待办。
- 采用看板跟踪任务，优先解决跨职能问题（如后端接口变更）。
- 保持文档同步更新，尤其是 PRD、API Spec 与数据库结构。

## 依赖与协调事项
- 数据基础设施：确认 DuckDB/Parquet 存储路径与访问权限。
- 插件团队：确保清洗插件符合标准接口，支持重试。
- DevOps：准备日志采集与监控指标方案。

## 交付清单
- 更新的 PRD、交互稿、API 文档。
- 后端服务（含迁移脚本、单元测试、Swagger）。
- 前端界面与交互逻辑。
- 导入流程的试运行报告（含性能指标、异常情况）。

## 进度追踪

### Milestone 0
- [x] 沉淀开放问题结论（错误日志弹窗、重试保留策略、原始文件目录约定）。
- [x] 交互稿：文本线框图已提交，后续如需补充高保真则另行规划。
- [x] API 草案审阅并锁定字段/响应格式。
- [x] 数据库迁移基础设施：TypeORM 数据源、脚本、首个迁移已落地。

### Milestone 1（进行中）
**后端**
- [x] 实体与迁移：`datasets` / `imports` 表结构、软删除字段、标签约束已实现。
- [x] 导入流程闭环：CSV 上传→清洗→`datasets` 记录（MVP），后续队列化/多格式待迭代。
- [x] 列表/状态/重试接口：`GET/POST /trading-data/imports`、`/datasets` 已提供，权限与筛选优化后续补充。

**前端**
- [x] 交易数据列表页初版（分页、状态展示、日志查看；筛选与自动轮询待迭代）。
- [x] 导入入口与重试流程（CSV 上传、失败重试弹窗、手动刷新）。
- [x] 元数据编辑 / 标签组件实现。

**测试**
- [x] 后端单元测试覆盖标签处理、状态机等关键逻辑。
- [x] 集成示例：新增 CSV 插件单测与导入接口伪集成用例（真实队列接入后补充全链路 E2E）。

### Milestone 2（未启动）
- [x] 导入任务详情页 + 错误日志查看  
  - 后端：扩展 `imports` 查询接口，输出阶段进度、统计摘要；错误日志接口支持分段拉取（offset/limit）以便“加载更多”。  
  - 前端：新增详情页面/抽屉，展示基础信息、阶段进度条、最近日志片段；错误日志以弹窗形式查看，可逐段加载更多记录。  
  - 验收：列表可跳转详情，失败任务在弹窗中查看日志并按需加载剩余内容。
- [x] 数据集列表“显示已删除”与恢复操作  
  - 后端：列表接口支持 `status=deleted/all` 过滤，恢复 API 返回最新数据。  
  - 前端：新增筛选项与标签展示，已删除记录提供恢复入口；恢复成功后自动刷新。  
  - 验收：切换筛选后可查看历史删除记录并完成恢复闭环。
- [x] 数据集追加写入能力  
  - 后端：追加任务调度（锁定 `dataset_id`）、时间区间合法性校验、Parquet 分区追加策略、失败重试限制。  
  - 前端：从数据集详情触发“追加数据”，沿用导入表单并展示当前时间边界说明；若存在进行中任务则提示不可追加。  
  - 验收：可在数据尾部（或头部）追加数据，原有区间未被覆盖，失败任务不可重试、需重新发起。
- [x] 交易数据可视化（TradingView 集成）  
  - 后端：实现 TradingView UDF/Lightweight 接口（`config`、`symbols`、`history`），支持按粒度聚合并读取最新 Parquet。  
  - 前端：在数据集详情页嵌入 TradingView 图表，支持粒度切换与范围浏览，追加后可刷新展示。  
  - 验收：指定数据集可在图表中查看 K 线与成交量，数据加载与追加后的更新正常。
- [x] 前后端集成测试完善  
  - 自动化：补充导入详情、日志下载、追加流程、恢复操作的 E2E/集成测试用例。  
  - 手动验证：覆盖主要用户路径，确保 TradingView 接口与前端交互一致。  
  - 验收：CI 通过新增测试，手工回归记录在发布清单中。

### Milestone 3（规划中）
- [ ] 导入监控与告警能力建设。
- [ ] 权限管理、批量导入、自动化调度等高级功能。
- [ ] 高保真交互稿或设计系统升级（如有需求）。
