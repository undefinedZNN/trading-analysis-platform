# 交易数据管理界面需求与交互设计

本文档从产品视角定义交易数据管理模块的核心需求与交互流程，覆盖数据列表、导入操作与任务进度展示，为后续产品设计与前端开发提供依据。

## 1. 背景与目标

- 为分析与回测团队提供统一的 OHLCV 数据管理界面。
- 支持手动导入不同来源的原始文件，并追踪清洗进度。
- 提供基础的元数据维护与数据删除能力，暂不涉及权限体系。

## 2. 主要用户场景

1. **数据导入**：运营/量化研究人员通过表单上传原始交易数据文件，填写必要元信息，跟踪上传与清洗进度。
2. **数据检索**：用户通过列表查询已导入的数据集，支持按多条件过滤、分页浏览。
3. **元数据维护**：用户对已存在的数据集调整标签、描述等附加信息。
4. **数据删除/恢复**：在确认不再需要的情况下对数据集执行软删除，并可在后续根据需要恢复记录（暂不物理清理文件，彻底删除流程后续扩展）。

## 3. 信息结构

- **交易数据列表页**
  - 顶部筛选区：来源、交易对、时间粒度、时间范围、标签关键字等。
  - 数据表格：展示数据集核心字段与当前清洗/导入状态。
  - 行内操作：编辑元信息、删除、查看详情。
  - 全局操作：导入新数据（按钮）。
- **导入数据页面**
  - 表单区域：输入基础信息并上传文件。
  - 状态区域：提交后显示上传进度、清洗进度、日志摘要；可返回列表页。
  - 轻量状态提醒：表单提交成功后保持在当前页，进度条实时更新。

## 4. 功能需求

### 4.1 数据列表

- 表格默认按 `created_at` 倒序，且仅显示未软删除的数据集（可通过筛选查看已删除项）。
- 支持分页，默认每页 20 条，可切换 20/50/100。
- 列字段建议包含：数据集 ID、来源、交易对、时间粒度、时间范围、记录数、自定义标签、状态、最新更新时间。
- 状态展示取自导入任务状态（`pending`/`uploading`/`processing`/`completed`/`failed`）。
- 列表需支持基于状态的颜色或标签提示。

### 4.2 筛选与查询

- 组合条件：来源（下拉，支持空值）、交易对（支持模糊搜索）、数据时间周期（时间粒度）、数据时间范围（区间选择器，筛选包含指定时间段的数据集）、创建时间范围、自定义标签（多选或关键字）、状态（含“已删除”选项）。
- 支持关键字搜索（针对交易对/自定义标签）。
- 每次查询刷新表格数据并重置分页到第一页。

### 4.3 元数据编辑

- 行内点击“编辑”打开侧栏或弹窗，允许修改描述、备注、自定义标签。自定义标签采用多选/自由输入的标签组件，支持新增多个标签并同步到 `labels` 字段；标签文本去除首尾空格后去重，长度限制 25 字以内，并可在下拉中展示推荐标签列表供快速选择。
- 编辑操作应即时更新 PostgreSQL 中的 `datasets.labels` 等字段。
- 成功保存后刷新当前行数据并提示“修改成功”。

### 4.4 数据删除与恢复

- 行内“删除”按钮需二次确认（弹窗说明：数据集将被软删除，可在后续恢复或彻底清理）。
- 删除成功后默认从列表移除该行并提示；列表提供“显示已删除”过滤项以便回溯。
- 对软删除记录提供“恢复”操作，点击后二次确认并调用恢复接口（将 `deleted_at` 置空）；恢复成功后重新回到正常列表。
- 删除失败时展示错误信息。

### 4.5 导入入口

- 列表页顶部固定的“导入数据”按钮，点击进入导入页面（或打开抽屉）。
- 导入页面包含以下表单字段：
  - 来源（可选，下拉）
  - 交易对（必填，文本或下拉，示例：`BTC/USDT`、`AAPL`）
  - 时间粒度（必填，下拉：如 1min / 5min / 1d）
  - 时间范围（可选，开始/结束时间）
  - 标签/描述（可选，支持从推荐标签中选择或手动输入，单个标签 ≤ 25 字，去除首尾空格并自动去重）
  - 数据文件上传（必填，支持 zst/CSV/JSON，单文件）
- 表单需校验必填项，上传文件需限制格式（zst/CSV/JSON）；当前阶段不限制大小。

### 4.6 上传与清洗进度

- 表单提交后保持在同一页面；表单控件置为只读或隐藏，仅展示只读信息和进度组件。
- 进度信息包括：
  - 文件上传进度（百分比，实时更新）。
  - 数据清洗进度（基于导入任务的 `progress` 字段）。
  - 当前阶段描述（上传中、清洗中、写入中等）。
  - 最新日志片段（可选，显示最近几条状态变更）。
- 上传完成但清洗进行中时显示分段进度：上传 100%，清洗进行 xx%。
- 清洗成功：展示“导入完成”状态、数据集编号，并提供“返回列表”按钮。
- 清洗失败：展示失败原因，并提供完整错误日志查看（支持滚动/复制）；可提供“重新导入”快捷操作（重新回到表单状态，保留先前输入的元信息与文件引用，允许重新上传）。

### 4.7 列表中的进度回溯

- 用户离开导入页面后，可在数据列表中看到对应记录的最新状态与进度条。
- 对于尚未完成的导入，行内展示小型进度条或状态标签（例如 65%）。
- 提供状态刷新机制（定时轮询或手动刷新按钮）。

## 5. 状态定义与反馈

| 状态 | 场景 | 列表展示 | 导入页展示 |
| --- | --- | --- | --- |
| `pending` | 任务创建，等待上传 | 灰色标签“排队中” | 提示“等待上传” |
| `uploading` | 文件正在上传 | 蓝色标签“上传中” + 百分比 | 上传进度条 |
| `processing` | 清洗/写入中 | 黄色标签“清洗中” + 百分比 | 清洗进度条，阶段提示 |
| `completed` | 导入完成 | 绿色标签“已完成” | 成功提示、返回入口 |
| `failed` | 失败终止 | 红色标签“失败” | 错误信息、重试入口 |

所有状态更新由后端的 `imports` 表驱动，前端通过轮询或 WebSocket 获取最新进度。

## 6. 数据字段规范

- **列表展示字段**
  - `dataset_id`
  - `source`（可为空）
  - `trading_pair`
  - `granularity`
  - `time_start` / `time_end`
  - `row_count`
  - `labels`（以自定义标签 tag 形式展示，支持多个）
  - `status`（映射导入状态）
  - `created_at`
  - `deleted_at`（仅在显示已删除数据时展示）
- **导入表单字段**
  - `source`、`trading_pair`、`granularity`、`time_start`、`time_end`
  - `labels`（自定义标签输入，支持多个）
  - `file`（上传控件）
- **进度信息字段**
  - `progress`（0-100）
  - `message` / `last_log`
  - `updated_at`

## 7. 交互流程概述

1. 用户在列表页点击“导入数据”。
2. 填写表单并上传文件，提交后进入进度视图。
3. 系统实时显示上传/清洗进度；用户可选择返回列表。
4. 列表页轮询刷新对应记录，显示最新状态。
5. 导入完成后，记录状态更新为“已完成”，可进行编辑、删除等操作；若失败，用户可重新导入。

## 8. 异常与提示

- **上传失败**：显示文件上传错误，提供完整错误日志并允许重新上传；状态回退到 `pending`。
- **清洗失败**：展示后端返回的错误摘要和完整错误日志，可直接触发重新上传/清洗流程。
- **删除数据集失败**：保留原状态并弹出错误提醒。
- **网络中断**：提示用户检查网络，恢复后自动继续轮询。

## 9. 后续扩展思路

- 引入多任务并发监控面板及批量操作。
- 增加导入任务历史、日志详情页。
- 与权限系统集成，实现角色管理与操作审计。

当前阶段优先实现基础的上传与进度反馈，确保流程闭环、状态可见。
